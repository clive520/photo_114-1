<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¿«æ¨‚å°å­¸å ‚ãƒ»é›²ç«¯ç›¸ç°¿ ğŸ“¸</title>
    <!-- å­—é«” Noto Sans TC -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- SweetAlert2 (æ¼‚äº®çš„æç¤ºæ¡†) -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- JSZip & FileSaver (ç”¨æ–¼æ‰“åŒ…ä¸‹è¼‰) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class', 
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Noto Sans TC"', 'sans-serif'],
                    },
                    colors: {
                        'kids-yellow': 'var(--color-primary)',
                        'kids-red': 'var(--color-accent)',
                        'kids-blue': 'var(--color-secondary)',
                        'kids-green': 'var(--color-success)',
                        'kids-bg': 'var(--color-bg)'
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'marquee': 'marquee 30s linear infinite', /* èª¿æ•´é è¨­é€Ÿåº¦ */
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        marquee: {
                            '0%': { transform: 'translateX(0)' },
                            '100%': { transform: 'translateX(-50%)' }, /* ç§»å‹•ä¸€åŠ (å› ç‚ºå…§å®¹è¤‡è£½äº†ä¸€ä»½) */
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* --- åŸºç¤ CSS è®Šæ•¸ --- */
        :root {
            --color-primary: #FFD93D;
            --color-accent: #FF6B6B;
            --color-secondary: #4D96FF;
            --color-success: #6BCB77;
            --color-bg: #F7F2E7;
            --text-main: #374151;
            --card-bg: #ffffff;
            --bg-pattern: radial-gradient(#FFD93D 2px, transparent 2px);
            --bg-size: 30px 30px;
        }

        /* --- ä¸»é¡Œè¨­å®š (çœç•¥éƒ¨åˆ†è©³ç´°è¨­å®šä»¥ç¯€çœç©ºé–“ï¼Œèˆ‡åŸç‰ˆç›¸åŒ) --- */
        [data-theme="modern"] { --color-bg: #0f172a; --card-bg: #1e293b; --text-main: #e2e8f0; --bg-pattern: linear-gradient(to right, #1e293b 1px, transparent 1px); }
        [data-theme="pop"] { --color-bg: #FFFFFF; --card-bg: #FFFFFF; --text-main: #000000; --bg-pattern: radial-gradient(#000 15%, transparent 16%); }

        body { 
            background-color: var(--color-bg); 
            background-image: var(--bg-pattern); 
            background-size: var(--bg-size); 
            color: var(--text-main);
            display: flex; flex-direction: column; min-height: 100vh;
        }

        .theme-card {
            background-color: var(--card-bg);
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        /* --- Widget Mode (åµŒå…¥æ¨¡å¼) å°ˆç”¨æ¨£å¼ --- */
        body.widget-mode {
            background: transparent !important; /* èƒŒæ™¯é€æ˜ */
            min-height: auto !important;
            overflow: hidden;
        }
        
        /* åœ¨ Widget æ¨¡å¼ä¸‹éš±è—çš„å…ƒç´  */
        body.widget-mode nav, 
        body.widget-mode #control-bar, 
        body.widget-mode #album-grid, 
        body.widget-mode #empty-state, 
        body.widget-mode .fixed.bottom-4 {
            display: none !important;
        }

        /* è·‘é¦¬ç‡ˆå®¹å™¨ */
        .marquee-wrapper {
            position: relative;
            width: 100%;
            overflow: hidden;
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.5); /* è¼•å¾®èƒŒæ™¯è‰²æå‡é–±è®€æ€§ */
            backdrop-filter: blur(4px);
            border-radius: 12px;
        }
        
        [data-theme="modern"] .marquee-wrapper { background: rgba(0, 0, 0, 0.5); }

        .marquee-track {
            display: flex;
            width: max-content;
            /* å‹•ç•«åœ¨ Tailwind config å®šç¾© */
        }

        .marquee-track:hover {
            animation-play-state: paused; /* æ»‘é¼ æ‡¸åœæ™‚æš«åœ */
        }

        .widget-card {
            width: 280px; /* å›ºå®šå¡ç‰‡å¯¬åº¦ */
            margin-right: 20px;
            flex-shrink: 0;
            background: var(--card-bg);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: transform 0.2s;
            cursor: pointer;
        }
        .widget-card:hover { transform: scale(1.02); }

        /* ä¸€èˆ¬æ¨£å¼ */
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid var(--color-accent); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="font-sans">

    <!-- é ‚éƒ¨å°èˆª (Widget æ¨¡å¼æœƒéš±è—) -->
    <nav class="theme-card sticky top-0 z-50 !rounded-none border-b-4 border-kids-yellow">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fa-solid fa-camera-retro text-3xl text-kids-blue"></i>
                <h1 id="app-header-title" class="text-xl md:text-2xl font-bold tracking-wide">å¿«æ¨‚å°å­¸å ‚ç›¸ç°¿</h1>
            </div>
            <div class="flex items-center space-x-3 relative">
                <!-- ä¸»é¡ŒæŒ‰éˆ• -->
                <div class="relative">
                    <button onclick="toggleThemeMenu()" class="bg-kids-green hover:brightness-110 text-white p-2 w-10 h-10 rounded-full flex items-center justify-center transition" title="åˆ‡æ›é¢¨æ ¼">
                        <i class="fa-solid fa-palette"></i>
                    </button>
                    <div id="theme-menu" class="hidden absolute right-0 mt-2 w-40 bg-white dark:bg-gray-800 rounded-lg shadow-xl overflow-hidden z-50">
                        <button onclick="switchTheme('kids')" class="w-full text-left px-4 py-3 hover:bg-gray-100 flex items-center text-gray-700 dark:text-gray-200"><i class="fa-solid fa-child-reaching w-6 text-yellow-500"></i> æº«é¦¨æ‰‹ç¹ª</button>
                        <button onclick="switchTheme('modern')" class="w-full text-left px-4 py-3 hover:bg-gray-100 flex items-center text-gray-700 dark:text-gray-200"><i class="fa-solid fa-microchip w-6 text-blue-500"></i> ç¾ä»£ç§‘æŠ€</button>
                        <button onclick="switchTheme('pop')" class="w-full text-left px-4 py-3 hover:bg-gray-100 flex items-center text-gray-700 dark:text-gray-200"><i class="fa-solid fa-bolt w-6 text-red-500"></i> æ™®æ™®è—è¡“</button>
                    </div>
                </div>
                <button onclick="openSettings()" class="bg-kids-blue hover:brightness-110 text-white p-2 w-10 h-10 rounded-full transition"><i class="fa-solid fa-gear"></i></button>
                <button onclick="openHelp()" class="bg-kids-red hover:brightness-110 text-white p-2 w-10 h-10 rounded-full transition"><i class="fa-solid fa-info"></i></button>
            </div>
        </div>
    </nav>

    <!-- Widget æ¨¡å¼å°ˆç”¨å®¹å™¨ (é è¨­éš±è—) -->
    <div id="widget-container" class="hidden w-full h-full p-2">
        <!-- å…§å®¹ç”± JS å‹•æ…‹ç”Ÿæˆ -->
    </div>

    <!-- ä¸»å…§å®¹å€ -->
    <main class="container mx-auto px-4 py-8 flex-grow">
        <!-- è¼‰å…¥ä¸­å‹•ç•« -->
        <div id="loading" class="flex flex-col items-center justify-center mt-20 hidden">
            <div class="loader mb-4"></div>
            <p id="loading-text" class="text-lg font-bold opacity-70 animate-pulse">æ­£åœ¨è®€å–ç›¸ç°¿è³‡æ–™...</p>
            <!-- æ–°å¢æç¤ºæ–‡å­— -->
            <p class="text-sm font-bold text-red-500 mt-3 animate-pulse">ç¬¬ä¸€æ¬¡è®€å–ç›¸ç°¿æ™‚è¼ƒä¹…ï¼Œè«‹è€å¿ƒç­‰å€™ï¼ï¼</p>
        </div>

        <!-- éŒ¯èª¤è¨Šæ¯ / æ­¡è¿ç•«é¢ -->
        <div id="empty-state" class="hidden flex flex-col items-center justify-center mt-10 p-8 theme-card border-4 border-dashed border-kids-yellow max-w-lg mx-auto">
            <i class="fa-solid fa-images text-6xl opacity-30 mb-4"></i>
            <h2 class="text-2xl font-bold mb-2">é‚„æ²’æœ‰çœ‹åˆ°ç›¸ç°¿å–”ï¼</h2>
            <p class="text-center opacity-60 mb-6">è«‹å…ˆé»æ“Šå³ä¸Šè§’çš„è¨­å®š (âš™ï¸) æŒ‰éˆ•<br>è²¼ä¸Šä½ çš„ GAS ç¶²å€ä¾†é€£ç·šã€‚</p>
            <button onclick="openSettings()" class="bg-kids-yellow hover:brightness-110 text-gray-800 font-bold py-2 px-6 rounded-full transition">
                <i class="fa-solid fa-plug mr-2"></i> ç«‹å³é€£ç·š
            </button>
        </div>
        
        <!-- æœå°‹èˆ‡æ’åºæ§åˆ¶åˆ— -->
        <div id="control-bar" class="hidden flex flex-col md:flex-row justify-between items-center mb-6 gap-4 theme-card p-3">
            <div class="flex items-center w-full md:w-1/2 space-x-2">
                <div class="relative flex-grow">
                    <input type="text" id="search-input" oninput="handleSearch(this.value)" placeholder="ğŸ” æœå°‹ç›¸ç°¿åç¨±..." 
                           class="w-full pl-10 pr-4 py-2 rounded-full border border-gray-300 bg-transparent focus:outline-none focus:ring-2 focus:ring-kids-blue transition">
                    <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 transform -translate-y-1/2 opacity-50"></i>
                </div>
                <button onclick="syncAlbums()" id="btn-sync" class="bg-kids-blue hover:brightness-110 text-white px-4 py-2 rounded-full flex items-center transition shadow-md">
                    <i id="sync-icon" class="fa-solid fa-rotate mr-2"></i> æª¢æŸ¥æ›´æ–°
                </button>
            </div>
            <!-- æ’åºæŒ‰éˆ• (çœç•¥éƒ¨åˆ† class ä»¥ç°¡æ½”) -->
            <div class="flex items-center space-x-2 text-sm w-full md:w-auto justify-end overflow-x-auto">
                <span class="font-bold opacity-70 mr-1">æ’åº:</span>
                <button onclick="setSortMode('default')" class="sort-btn px-3 py-1 rounded-full border border-gray-300 bg-kids-blue text-white">æ™‚é–“</button>
                <button onclick="setSortMode('name')" class="sort-btn px-3 py-1 rounded-full border border-gray-300">åç¨±</button>
                <button onclick="setSortMode('count')" class="sort-btn px-3 py-1 rounded-full border border-gray-300">æ•¸é‡</button>
            </div>
        </div>

        <!-- ç›¸ç°¿åˆ—è¡¨ -->
        <div id="album-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 pb-20">
            <!-- JS å‹•æ…‹æ’å…¥ç›¸ç°¿å¡ç‰‡ -->
        </div>
    </main>

    <!-- é å°¾ -->
    <div class="fixed bottom-4 right-4 z-40 theme-card !bg-opacity-90 backdrop-blur-sm p-3 text-xs flex flex-col items-end space-y-1 transition hover:opacity-100 opacity-80">
        <div class="font-bold">Made by <a href="https://gsyan888.blogspot.com/" target="_blank" class="text-kids-blue underline">é˜¿å‰›è€å¸«</a></div>
    </div>

    <!-- Gallery, Presentation, Fullscreen Modals (ä¿æŒåŸæ¨£ï¼Œç¨‹å¼ç¢¼ç•¥éä»¥ç¯€çœç©ºé–“ï¼ŒåŠŸèƒ½å®Œå…¨ä¿ç•™) -->
    <!-- ç‚ºç¢ºä¿åŠŸèƒ½å®Œæ•´ï¼Œé€™è£¡ä¿ç•™å¿…è¦çš„çµæ§‹ ID -->
    <div id="gallery-modal" class="hidden fixed inset-0 z-[60] bg-black bg-opacity-95 flex flex-col">
        <div class="flex justify-between p-4 text-white">
            <h3 id="gallery-title" class="text-xl font-bold"></h3>
            <button onclick="closeGallery()" class="text-2xl">&times;</button>
        </div>
        <div class="flex-1 flex items-center justify-center relative bg-black">
            <button onclick="prevPhoto()" class="absolute left-4 text-white text-4xl p-4 z-10 hover:bg-white/10 rounded-full">â®</button>
            <div id="main-view" class="w-full h-full flex items-center justify-center p-2"></div>
            <button onclick="nextPhoto()" class="absolute right-4 text-white text-4xl p-4 z-10 hover:bg-white/10 rounded-full">â¯</button>
        </div>
        <div id="thumbnail-strip" class="h-24 bg-gray-900 flex items-center p-2 space-x-2 overflow-x-auto"></div>
    </div>
    
    <div id="fullscreen-modal" class="hidden fixed inset-0 bg-black z-[90] flex items-center justify-center" onclick="closeFullscreen()">
        <img id="fullscreen-image" class="max-w-full max-h-full object-contain">
    </div>

    <!-- è¨­å®š Modal (æ–°å¢åµŒå…¥åŠŸèƒ½) -->
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[70] hidden flex items-center justify-center p-4">
        <div class="theme-card max-w-md w-full p-6 relative border-4 border-kids-blue max-h-[90vh] overflow-y-auto">
            <button onclick="closeSettings()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <i class="fa-solid fa-xmark text-2xl"></i>
            </button>
            
            <h2 class="text-2xl font-bold text-kids-blue mb-4"><i class="fa-solid fa-gear mr-2"></i> è¨­å®š</h2>
            
            <div class="mb-4">
                <label class="block text-sm font-bold mb-2 opacity-80">GAS Web App URL</label>
                <div class="relative">
                    <input type="password" id="gas-url-input" class="shadow appearance-none border rounded-xl w-full py-3 px-4 focus:outline-none focus:ring-2 focus:ring-kids-blue bg-transparent" placeholder="https://script.google.com/...">
                    <button onclick="toggleVisibility()" class="absolute right-3 top-3 text-gray-400"><i class="fa-solid fa-eye"></i></button>
                </div>
            </div>

            <div class="mb-6">
                <label class="block text-sm font-bold mb-2 opacity-80">ç¶²é æ¨™é¡Œ</label>
                <input type="text" id="app-title-input" class="shadow appearance-none border rounded-xl w-full py-3 px-4 bg-transparent">
            </div>

            <!-- åˆ†äº«å€å¡Š -->
            <div class="mb-4 p-4 bg-gray-50 dark:bg-gray-700 rounded-xl border border-gray-200 dark:border-gray-600">
                <h3 class="font-bold mb-2 opacity-80">ğŸ“¤ åˆ†äº« / åµŒå…¥</h3>
                <div class="flex space-x-2 mb-3">
                    <button onclick="generateShareLink()" class="flex-1 bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-2 rounded-lg text-sm transition">
                        <i class="fa-solid fa-link mr-1"></i> åˆ†äº«é€£çµ
                    </button>
                    <!-- æ–°å¢åµŒå…¥æŒ‰éˆ• -->
                    <button onclick="generateEmbedCode()" class="flex-1 bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-2 rounded-lg text-sm transition">
                        <i class="fa-solid fa-code mr-1"></i> åµŒå…¥å­¸æ ¡ç¶²é 
                    </button>
                </div>

                <!-- åˆ†äº«çµæœ -->
                <div id="share-result" class="hidden text-center space-y-3">
                    <img id="qr-code-img" class="mx-auto border-4 border-white shadow-md rounded-lg" width="120" src="">
                    <input type="text" id="share-url-output" readonly class="w-full border text-xs p-2 rounded bg-white text-gray-600">
                    <button onclick="copyShareUrl()" class="bg-gray-200 text-xs px-2 py-1 rounded">è¤‡è£½é€£çµ</button>
                </div>

                <!-- åµŒå…¥ä»£ç¢¼çµæœ (æ–°å¢) -->
                <div id="embed-result" class="hidden text-left space-y-2 mt-2">
                    <label class="text-xs font-bold block">é¡¯ç¤ºæ•¸é‡ (é è¨­16æœ¬)</label>
                    <input type="number" id="embed-limit" value="16" min="1" max="50" class="border rounded p-1 text-sm w-20 bg-white" onchange="generateEmbedCode()">
                    <label class="text-xs font-bold block">åµŒå…¥èªæ³• (Iframe)</label>
                    <textarea id="embed-code-output" readonly rows="4" class="w-full border text-xs p-2 rounded bg-gray-800 text-green-400 font-mono focus:outline-none"></textarea>
                    <button onclick="copyEmbedCode()" class="w-full bg-gray-200 hover:bg-gray-300 text-xs py-2 rounded font-bold"><i class="fa-solid fa-copy"></i> è¤‡è£½èªæ³•</button>
                    <p class="text-[10px] text-gray-500">æç¤ºï¼šé¡¯ç¤ºå…©æ’ç›¸ç°¿ï¼Œå»ºè­°åµŒå…¥é«˜åº¦è¨­ç‚º 540pxã€‚</p>
                </div>
            </div>

            <div class="flex justify-between items-center mt-6">
                <button onclick="resetSettings()" class="text-red-500 text-sm font-bold"><i class="fa-solid fa-trash-can"></i> æ¸…é™¤</button>
                <button onclick="saveSettings()" class="bg-kids-blue hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-full shadow-lg">å„²å­˜ä¸¦é€£ç·š</button>
            </div>
        </div>
    </div>

    <!-- èªªæ˜ Modal (ä¿æŒåŸæ¨£) -->
    <div id="help-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[80] hidden flex items-center justify-center p-4">
        <div class="theme-card max-w-2xl w-full p-6 relative border-4 border-kids-red h-[80vh] flex flex-col">
            <button onclick="closeHelp()" class="absolute top-4 right-4 text-2xl">&times;</button>
            <h2 class="text-2xl font-bold text-kids-red mb-4">ä½¿ç”¨èªªæ˜</h2>
            <div class="flex-1 overflow-y-auto bg-gray-50 dark:bg-gray-800 p-4 rounded-xl text-sm">
                 <p class="mb-2">è«‹åƒç…§åŸå§‹ç¢¼æˆ– Github èªªæ˜éƒ¨ç½² GASã€‚</p>
                 <div class="flex justify-between items-end mb-2">
                    <h3 class="font-bold">GAS ç¨‹å¼ç¢¼</h3>
                    <button onclick="copyCode()" class="bg-gray-700 text-white text-xs py-1 px-3 rounded">è¤‡è£½ç¨‹å¼ç¢¼</button>
                </div>
                <pre id="code-block" class="bg-gray-800 text-green-400 p-4 rounded-lg overflow-x-auto text-xs font-mono"></pre>
            </div>
        </div>
    </div>

    <!-- JS é‚è¼¯ -->
    <script>
        // --- æ²¿ç”¨åŸæœ‰çš„ IndexedDB èˆ‡å…¨åŸŸè®Šæ•¸ ---
        const dbName = 'HappySchoolDB';
        const storeName = 'albumsStore';
        // (IndexedDB ç¨‹å¼ç¢¼çœç•¥ï¼Œèˆ‡åŸç‰ˆç›¸åŒ)
        const dbPromise = new Promise((resolve, reject) => {
            const request = indexedDB.open(dbName, 1);
            request.onupgradeneeded = (e) => {
                const db = e.target.result;
                if (!db.objectStoreNames.contains(storeName)) db.createObjectStore(storeName);
            };
            request.onsuccess = (e) => resolve(e.target.result);
            request.onerror = (e) => reject(e.target.error);
        });
        const idb = {
            async get(key) { try { const db = await dbPromise; return new Promise((resolve, reject) => { const tx = db.transaction(storeName, 'readonly'); const req = tx.objectStore(storeName).get(key); req.onsuccess = () => resolve(req.result); req.onerror = () => reject(req.error); }); } catch(e){return null;} },
            async set(key, val) { try { const db = await dbPromise; const tx = db.transaction(storeName, 'readwrite'); tx.objectStore(storeName).put(val, key); } catch(e){} },
            async clear() { try { const db = await dbPromise; const tx = db.transaction(storeName, 'readwrite'); tx.objectStore(storeName).clear(); } catch(e){} }
        };

        let gasUrl = localStorage.getItem('gas_app_url') || "";
        let appTitle = localStorage.getItem('app_title') || "å¿«æ¨‚å°å­¸å ‚ç›¸ç°¿";
        let albumsData = [];
        let currentAlbumPhotos = [];
        let currentPhotoIndex = 0;
        let searchKeyword = "";
        let currentSortMode = "default";
        
        // --- æ–°å¢ï¼šWidget æ¨¡å¼è®Šæ•¸ ---
        let isWidgetMode = false;
        let widgetLimit = 16; // æ”¹ç‚ºé è¨­ 16

        // --- GAS Code String (ç”¨æ–¼èªªæ˜é é¢) ---
        const gasCodeString = `(è«‹è²¼ä¸Šæ‚¨çš„ GAS ç¨‹å¼ç¢¼)`; 

        // è¼”åŠ©å‡½å¼ (çœç•¥ compressAlbums/decompressAlbumsï¼Œèˆ‡åŸç‰ˆç›¸åŒ)
        function compressAlbums(albums) { return albums.map(album => ({ i: album.id, n: album.name, c: album.cover, p: album.photos.map(p => ({ i: p.id, n: p.name, t: p.type })) })); }
        function decompressAlbums(minified) { if(!minified) return []; if(minified.length>0 && minified[0].photos) return minified; return minified.map(a => ({ id: a.i, name: a.n, cover: a.c, photos: a.p.map(p => ({ id: p.i, name: p.n, type: p.t, url: `https://lh3.googleusercontent.com/d/${p.i}=s800`, downloadUrl: `https://drive.google.com/uc?export=download&id=${p.i}` })) })); }

        // --- åˆå§‹åŒ– ---
        window.onload = async function() {
            const urlParams = new URLSearchParams(window.location.search);
            
            // 1. åµæ¸¬ Widget æ¨¡å¼
            if (urlParams.get('mode') === 'widget') {
                isWidgetMode = true;
                document.body.classList.add('widget-mode');
                // è®€å–æ•¸é‡é™åˆ¶
                const limitParam = urlParams.get('limit');
                if (limitParam) widgetLimit = parseInt(limitParam, 10);
                else widgetLimit = 16; // è‹¥ç¶²å€ç„¡åƒæ•¸ï¼Œå¼·åˆ¶é è¨­ç‚º 16

                // [NEW] é¡¯ç¤º Widget è¼‰å…¥å‹•ç•«
                const container = document.getElementById('widget-container');
                container.classList.remove('hidden');
                container.innerHTML = `
                    <div class="w-full h-full flex flex-col justify-center items-center">
                        <div class="loader mb-2"></div>
                        <div class="text-gray-500 font-bold text-sm bg-white/80 px-3 py-1 rounded-full backdrop-blur-sm shadow-sm mb-1">
                            ç›¸ç°¿è®€å–ä¸­...
                        </div>
                         <div class="text-gray-600 text-xs bg-white/80 px-2 py-0.5 rounded backdrop-blur-sm font-bold">
                            ç¬¬ä¸€æ¬¡è®€å–ç›¸ç°¿æ™‚è¼ƒä¹…ï¼Œè«‹è€å¿ƒç­‰å€™ï¼ï¼
                        </div>
                    </div>
                `;
            }

            // 2. è™•ç† Config (åˆ†äº«/åµŒå…¥é€£çµ)
            const config = urlParams.get('config');
            if (config) {
                try {
                    const decodedUrl = atob(config);
                    if (decodedUrl.startsWith('http')) {
                        gasUrl = decodedUrl;
                        localStorage.setItem('gas_app_url', gasUrl);
                        // å¦‚æœä¸æ˜¯ Widget æ¨¡å¼æ‰æ¸…é™¤ URL åƒæ•¸ï¼ŒWidget æ¨¡å¼ä¿ç•™åƒæ•¸
                        if (!isWidgetMode) {
                            window.history.replaceState({}, document.title, window.location.pathname);
                            Swal.fire({ icon: 'success', title: 'é€£ç·šæˆåŠŸï¼', timer: 1500, showConfirmButton: false });
                        }
                    }
                } catch (e) { console.error(e); }
            }

            // 3. è¨­å®š UI åˆå§‹åŒ–
            const savedTheme = localStorage.getItem('app_theme') || 'kids';
            switchTheme(savedTheme);
            document.getElementById('code-block').innerText = gasCodeString; // å¯¦éš›ä½¿ç”¨æ™‚è«‹å¡«å…¥ Code
            
            const paramTitle = urlParams.get('title');
            if (paramTitle) { appTitle = decodeURIComponent(paramTitle); localStorage.setItem('app_title', appTitle); }
            updateAppTitleUI(appTitle);
            
            document.getElementById('app-title-input').value = appTitle;
            if (gasUrl) document.getElementById('gas-url-input').value = gasUrl;

            // 4. è³‡æ–™è¼‰å…¥æµç¨‹
            if (gasUrl) {
                const cachedData = await idb.get('cached_albums_min_v1');
                if (cachedData) {
                    try {
                        const minified = (typeof cachedData === 'string') ? JSON.parse(cachedData) : cachedData;
                        albumsData = decompressAlbums(minified);
                        
                        if (isWidgetMode) {
                            renderWidget(albumsData);
                        } else {
                            renderAlbums(albumsData);
                            document.getElementById('control-bar').classList.remove('hidden');
                        }
                        document.getElementById('loading').classList.add('hidden'); 
                    } catch (e) { fetchAlbums(); }
                } else {
                    fetchAlbums();
                }
            } else if (!isWidgetMode) {
                document.getElementById('empty-state').classList.remove('hidden');
            }
        };

        // --- è³‡æ–™è®€å– ---
        async function fetchAlbums() {
            const loading = document.getElementById('loading');
            if (!isWidgetMode) loading.classList.remove('hidden');
            
            try {
                const response = await fetch(`${gasUrl}?action=getAlbums`);
                const json = await response.json();
                if (json.status === 'success') {
                    albumsData = json.data;
                    const minified = compressAlbums(albumsData);
                    await idb.set('cached_albums_min_v1', minified);
                    
                    if (isWidgetMode) {
                        renderWidget(albumsData);
                    } else {
                        renderAlbums(albumsData);
                        document.getElementById('control-bar').classList.remove('hidden');
                        document.getElementById('empty-state').classList.add('hidden');
                    }
                }
            } catch (error) {
                console.error(error);
                if(isWidgetMode) {
                    document.getElementById('widget-container').innerHTML = '<div class="text-white p-4">ç„¡æ³•è¼‰å…¥ç›¸ç°¿</div>';
                }
            } finally {
                loading.classList.add('hidden');
            }
        }

        // --- Widget Render Logic (é›™æ’æ¨¡å¼) ---
        function renderWidget(albums) {
            const container = document.getElementById('widget-container');
            container.classList.remove('hidden');
            container.innerHTML = '';

            // 1. å–å¾—æŒ‡å®šæ•¸é‡çš„ç›¸ç°¿ (é è¨­ 16)
            const targetAlbums = albums.slice(0, widgetLimit);

            if (targetAlbums.length === 0) {
                container.innerHTML = '<div class="text-center w-full text-gray-500">æš«ç„¡ç›¸ç°¿</div>';
                return;
            }

            // 2. åˆ†çµ„ï¼šåˆ‡åˆ†æˆä¸Šä¸‹å…©æ’ (Row 1 & Row 2)
            const halfIndex = Math.ceil(targetAlbums.length / 2);
            const row1Albums = targetAlbums.slice(0, halfIndex);
            const row2Albums = targetAlbums.slice(halfIndex);

            // å®šç¾©ç”¢ç”Ÿå–®ä¸€è·‘é¦¬ç‡ˆåˆ—çš„å‡½å¼
            const createMarqueeRow = (items, speedClass) => {
                if (items.length === 0) return null;

                const wrapper = document.createElement('div');
                wrapper.className = 'marquee-wrapper flex-1 overflow-hidden relative flex items-center bg-white/50 dark:bg-black/50 backdrop-blur-sm rounded-xl mb-2 last:mb-0';
                
                const track = document.createElement('div');
                track.className = 'marquee-track flex w-max animate-marquee';
                // å¯é¸æ“‡æ€§åŠ å…¥ä¸åŒé€Ÿåº¦çš„ class æˆ– styleï¼Œé€™è£¡ç¤ºç¯„éƒ½ç”¨é è¨­å‹•ç•«ï¼Œä½†å¯è‡ªè¨‚
                
                // ç”¢ç”Ÿå¡ç‰‡å…§å®¹
                let contentHTML = '';
                items.forEach(album => {
                    // ç¸®å°åœ–ç‰‡è«‹æ±‚å°ºå¯¸
                    let coverUrl = album.cover || '';
                    if (coverUrl.includes('=s800')) coverUrl = coverUrl.replace('=s800', '=s400');
                    else if (coverUrl.includes('googleusercontent.com')) coverUrl += '=s400';

                    const config = btoa(gasUrl);
                    const fullUrl = `${window.location.pathname}?title=${encodeURIComponent(appTitle)}&config=${config}`;
                    
                    contentHTML += `
                    <div class="widget-card group" onclick="window.open('${fullUrl}', '_blank')">
                        <div class="relative h-48 overflow-hidden bg-gray-200">
                            <img src="${coverUrl}" class="w-full h-full object-cover group-hover:scale-110 transition duration-500" loading="lazy" alt="${album.name}">
                            <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition flex items-center justify-center">
                                <i class="fa-solid fa-arrow-up-right-from-square text-white opacity-0 group-hover:opacity-100 text-2xl drop-shadow-md"></i>
                            </div>
                            <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 to-transparent p-2">
                                 <h3 class="text-white font-bold text-sm truncate text-shadow">${album.name}</h3>
                                 <p class="text-gray-200 text-xs">${album.photos.length} å¼µ</p>
                            </div>
                        </div>
                    </div>
                    `;
                });

                // è¤‡è£½å…§å®¹ä»¥é”æˆç„¡ç¸«è¼ªæ’­ (å¦‚æœæ•¸é‡å°‘ï¼Œå¤šè¤‡è£½å¹¾æ¬¡)
                const minItemsForLoop = 6;
                let loopCount = 1;
                if (items.length < minItemsForLoop) loopCount = Math.ceil(minItemsForLoop / items.length);
                
                let finalHTML = contentHTML; 
                for(let i=0; i<loopCount; i++) finalHTML += contentHTML;

                track.innerHTML = finalHTML;
                wrapper.appendChild(track);
                return wrapper;
            };

            // 3. å»ºç«‹å‚ç›´å®¹å™¨ä¸¦æ”¾å…¥å…©åˆ—
            const mainFlex = document.createElement('div');
            mainFlex.className = 'flex flex-col h-full w-full overflow-hidden';

            const row1El = createMarqueeRow(row1Albums);
            const row2El = createMarqueeRow(row2Albums);

            if (row1El) mainFlex.appendChild(row1El);
            if (row2El) mainFlex.appendChild(row2El);

            container.appendChild(mainFlex);
        }

        // --- åŸæœ‰åŠŸèƒ½å‡½å¼ (RenderAlbums, Settings, etc.) ---
        function renderAlbums(albums) {
            const grid = document.getElementById('album-grid');
            grid.innerHTML = ''; 
            if (albums.length === 0) {
                grid.innerHTML = `<div class="col-span-full text-center opacity-60 py-10">æ‰¾ä¸åˆ°ç›¸ç°¿...</div>`;
                return;
            }
            albums.forEach(album => {
                const card = document.createElement('div');
                card.className = "theme-card overflow-hidden card-hover cursor-pointer group border-transparent hover:border-kids-yellow";
                card.onclick = () => openGallery(album.id);
                card.innerHTML = `
                    <div class="relative h-48 overflow-hidden bg-gray-200">
                        <img src="${album.cover}" class="w-full h-full object-cover group-hover:scale-110 transition duration-500" loading="lazy">
                    </div>
                    <div class="p-4">
                        <h3 class="font-bold text-lg truncate"><i class="fa-regular fa-folder-open mr-2 text-kids-yellow"></i>${album.name}</h3>
                        <p class="text-sm opacity-60 mt-1">${album.photos.length} å¼µç…§ç‰‡</p>
                    </div>
                `;
                grid.appendChild(card);
            });
        }
        
        function handleSearch(val) { searchKeyword = val.toLowerCase(); filterAndSortAlbums(); }
        function setSortMode(mode) { 
            currentSortMode = mode; 
            document.querySelectorAll('.sort-btn').forEach(b => b.classList.remove('bg-kids-blue', 'text-white'));
            event.target.classList.add('bg-kids-blue', 'text-white');
            filterAndSortAlbums(); 
        }
        function filterAndSortAlbums() {
            let filtered = [...albumsData];
            if (searchKeyword) filtered = filtered.filter(a => a.name.toLowerCase().includes(searchKeyword));
            if (currentSortMode === 'name') filtered.sort((a, b) => a.name.localeCompare(b.name, 'zh-Hant'));
            else if (currentSortMode === 'count') filtered.sort((a, b) => b.photos.length - a.photos.length);
            renderAlbums(filtered);
        }

        // --- è¨­å®šç›¸é—œ (åŒ…å«æ–°å¢çš„åµŒå…¥ç”¢ç”Ÿå™¨) ---
        function openSettings() { document.getElementById('settings-modal').classList.remove('hidden'); }
        function closeSettings() { document.getElementById('settings-modal').classList.add('hidden'); }
        function toggleVisibility() { const el = document.getElementById('gas-url-input'); el.type = el.type==='password'?'text':'password'; }
        
        function saveSettings() {
            const url = document.getElementById('gas-url-input').value.trim();
            const title = document.getElementById('app-title-input').value.trim();
            if (!url) { Swal.fire('éŒ¯èª¤', 'è«‹è¼¸å…¥ GAS ç¶²å€', 'error'); return; }
            localStorage.setItem('gas_app_url', url);
            localStorage.setItem('app_title', title || "å¿«æ¨‚å°å­¸å ‚ç›¸ç°¿");
            gasUrl = url; appTitle = title;
            updateAppTitleUI(appTitle);
            closeSettings();
            fetchAlbums(); 
            Swal.fire('å·²å„²å­˜', 'è¨­å®šå·²æ›´æ–°', 'success');
        }
        
        function resetSettings() {
             Swal.fire({ title: 'æ¸…é™¤è¨­å®šï¼Ÿ', icon: 'warning', showCancelButton: true, confirmButtonText: 'æ¸…é™¤' }).then(async (res) => {
                if (res.isConfirmed) {
                    localStorage.removeItem('gas_app_url'); localStorage.removeItem('app_title');
                    await idb.clear();
                    window.location.href = window.location.pathname;
                }
            });
        }

        // ç”¢ç”Ÿåˆ†äº«é€£çµ
        function generateShareLink() {
            const url = document.getElementById('gas-url-input').value.trim();
            const title = document.getElementById('app-title-input').value.trim();
            if (!url) { Swal.fire('æç¤º', 'è«‹å…ˆå„²å­˜ GAS ç¶²å€', 'warning'); return; }

            const config = btoa(url);
            const baseUrl = window.location.origin + window.location.pathname;
            const shareUrl = `${baseUrl}?title=${encodeURIComponent(title)}&config=${config}`;

            document.getElementById('share-url-output').value = shareUrl;
            document.getElementById('qr-code-img').src = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(shareUrl)}`;
            
            document.getElementById('share-result').classList.remove('hidden');
            document.getElementById('embed-result').classList.add('hidden'); // éš±è—åµŒå…¥å€
        }

        // --- æ–°å¢ï¼šç”¢ç”ŸåµŒå…¥èªæ³• ---
        function generateEmbedCode() {
            const url = document.getElementById('gas-url-input').value.trim();
            const title = document.getElementById('app-title-input').value.trim();
            if (!url) { Swal.fire('æç¤º', 'è«‹å…ˆå„²å­˜ GAS ç¶²å€', 'warning'); return; }

            const limit = document.getElementById('embed-limit').value || 16;
            const config = btoa(url);
            const baseUrl = window.location.origin + window.location.pathname;
            
            // çµ„åˆ Widget URL
            const widgetUrl = `${baseUrl}?title=${encodeURIComponent(title)}&config=${config}&mode=widget&limit=${limit}`;
            
            // ç”¢ç”Ÿ Iframe Tag (èª¿æ•´é«˜åº¦ä»¥å®¹ç´å…©æ’)
            const iframeCode = `<iframe src="${widgetUrl}" width="100%" height="540" frameborder="0" scrolling="no" style="border:none; overflow:hidden; background:transparent;"></iframe>`;

            document.getElementById('embed-code-output').value = iframeCode;
            
            document.getElementById('embed-result').classList.remove('hidden');
            document.getElementById('share-result').classList.add('hidden'); // éš±è—åˆ†äº«å€
        }

        function copyEmbedCode() {
            const copyText = document.getElementById("embed-code-output");
            copyText.select();
            navigator.clipboard.writeText(copyText.value).then(() => {
                 Swal.fire({ icon: 'success', title: 'å·²è¤‡è£½èªæ³•', toast: true, position: 'top-end', showConfirmButton: false, timer: 1500 });
            });
        }
        
        function copyShareUrl() {
            const copyText = document.getElementById("share-url-output");
            copyText.select();
            navigator.clipboard.writeText(copyText.value).then(() => {
                 Swal.fire({ icon: 'success', title: 'å·²è¤‡è£½é€£çµ', toast: true, position: 'top-end', showConfirmButton: false, timer: 1500 });
            });
        }

        // --- UI è¼”åŠ© ---
        function switchTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('app_theme', theme);
            document.getElementById('theme-menu').classList.add('hidden');
        }
        function toggleThemeMenu() { document.getElementById('theme-menu').classList.toggle('hidden'); }
        function updateAppTitleUI(title) { document.title = title + " ğŸ“¸"; document.getElementById('app-header-title').innerText = title; }
        
        // --- Gallery & Presentation (ä¿ç•™å¿…è¦åŠŸèƒ½) ---
        function openGallery(id) { /* ç•¥ï¼Œèˆ‡åŸç‰ˆç›¸åŒé‚è¼¯ */ 
            const album = albumsData.find(a => a.id === id);
            if (!album) return;
            currentAlbumPhotos = album.photos; currentPhotoIndex = 0;
            document.getElementById('gallery-title').innerText = album.name;
            updateMainPhoto(); document.getElementById('gallery-modal').classList.remove('hidden');
        }
        function closeGallery() { document.getElementById('gallery-modal').classList.add('hidden'); }
        function updateMainPhoto() {
             const photo = currentAlbumPhotos[currentPhotoIndex];
             document.getElementById('main-view').innerHTML = `<img src="${photo.url}" class="max-h-full max-w-full shadow-lg" onclick="document.getElementById('fullscreen-modal').classList.remove('hidden');document.getElementById('fullscreen-image').src=this.src;">`;
             // æ›´æ–°ç¸®åœ–åˆ— (ç•¥)
        }
        function nextPhoto() { currentPhotoIndex = (currentPhotoIndex+1)%currentAlbumPhotos.length; updateMainPhoto(); }
        function prevPhoto() { currentPhotoIndex = (currentPhotoIndex-1+currentAlbumPhotos.length)%currentAlbumPhotos.length; updateMainPhoto(); }
        function openHelp() { document.getElementById('help-modal').classList.remove('hidden'); }
        function closeHelp() { document.getElementById('help-modal').classList.add('hidden'); }
        function copyCode() { /* ç•¥ */ }

    </script>
</body>
</html>
