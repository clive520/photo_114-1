<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¿«æ¨‚å°å­¸å ‚ãƒ»é›²ç«¯ç›¸ç°¿ ğŸ“¸</title>
    <!-- å­—é«” Noto Sans TC -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- SweetAlert2 (æ¼‚äº®çš„æç¤ºæ¡†) -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- JSZip & FileSaver (ç”¨æ–¼æ‰“åŒ…ä¸‹è¼‰) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class', // å•Ÿç”¨ class æ¨¡å¼ä»¥ä¾¿æ‰‹å‹•æ§åˆ¶
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Noto Sans TC"', 'sans-serif'],
                    },
                    colors: {
                        'kids-yellow': 'var(--color-primary)',
                        'kids-red': 'var(--color-accent)',
                        'kids-blue': 'var(--color-secondary)',
                        'kids-green': 'var(--color-success)',
                        'kids-bg': 'var(--color-bg)'
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'marquee': 'marquee 30s linear infinite', 
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        marquee: {
                            '0%': { transform: 'translateX(0)' },
                            '100%': { transform: 'translateX(-50%)' }, 
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* --- åŸºç¤ CSS è®Šæ•¸ (é è¨­: æº«é¦¨æ‰‹ç¹ª) --- */
        :root {
            --color-primary: #FFD93D;
            --color-accent: #FF6B6B;
            --color-secondary: #4D96FF;
            --color-success: #6BCB77;
            --color-bg: #F7F2E7;
            --text-main: #374151;
            --card-bg: #ffffff;
            --border-width: 0px;
            --border-color: transparent;
            --shadow-style: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --radius-main: 1.5rem; /* rounded-3xl */
            --radius-btn: 9999px; /* rounded-full */
            --bg-pattern: radial-gradient(#FFD93D 2px, transparent 2px);
            --bg-size: 30px 30px;
        }

        /* --- ä¸»é¡Œï¼šç¾ä»£ç§‘æŠ€ (Modern) --- */
        [data-theme="modern"] {
            --color-primary: #0ea5e9; /* Sky Blue */
            --color-accent: #f43f5e; /* Rose */
            --color-secondary: #6366f1; /* Indigo */
            --color-success: #10b981; /* Emerald */
            --color-bg: #0f172a; /* Slate 900 */
            --text-main: #e2e8f0; /* Slate 200 */
            --card-bg: #1e293b; /* Slate 800 */
            --border-width: 1px;
            --border-color: #334155;
            --shadow-style: 0 0 15px rgba(14, 165, 233, 0.3); /* Glow effect */
            --radius-main: 0.5rem; /* rounded-lg */
            --radius-btn: 0.25rem; /* rounded */
            /* ç§‘æŠ€ç¶²æ ¼èƒŒæ™¯ */
            --bg-pattern: linear-gradient(to right, #1e293b 1px, transparent 1px), linear-gradient(to bottom, #1e293b 1px, transparent 1px);
            --bg-size: 40px 40px;
        }

        /* --- ä¸»é¡Œï¼šæ™®æ™®è—è¡“ (Pop Art) --- */
        [data-theme="pop"] {
            --color-primary: #FFD600; /* Vivid Yellow */
            --color-accent: #FF0055; /* Vivid Red */
            --color-secondary: #0099FF; /* Vivid Blue */
            --color-success: #00CC00;
            --color-bg: #FFFFFF;
            --text-main: #000000;
            --card-bg: #FFFFFF;
            --border-width: 3px;
            --border-color: #000000;
            --shadow-style: 4px 4px 0px 0px #000000; /* Hard Shadow */
            --radius-main: 0px;
            --radius-btn: 0px;
            /* ç¶²é»èƒŒæ™¯ (Halftone) */
            --bg-pattern: radial-gradient(#000 15%, transparent 16%);
            --bg-size: 16px 16px;
        }

        /* --- æ‡‰ç”¨è®Šæ•¸ --- */
        body { 
            background-color: var(--color-bg); 
            background-image: var(--bg-pattern); 
            background-size: var(--bg-size); 
            color: var(--text-main);
            display: flex; flex-direction: column; min-height: 100vh;
            transition: background-color 0.5s ease, color 0.3s ease;
        }

        /* å¡ç‰‡èˆ‡å®¹å™¨æ¨£å¼è¦†å¯« */
        .theme-card {
            background-color: var(--card-bg);
            border: var(--border-width) solid var(--border-color);
            box-shadow: var(--shadow-style);
            border-radius: var(--radius-main);
            transition: all 0.3s ease;
        }
        .theme-btn {
            border-radius: var(--radius-btn);
            box-shadow: var(--shadow-style);
        }
        
        /* é‡å°ä¸åŒä¸»é¡Œçš„ç‰¹æ®Šå¾®èª¿ */
        [data-theme="modern"] .card-hover:hover {
            box-shadow: 0 0 25px rgba(14, 165, 233, 0.6);
            border-color: var(--color-primary);
        }
        [data-theme="pop"] .card-hover:hover {
            transform: translate(-4px, -4px);
            box-shadow: 8px 8px 0px 0px #000000;
        }
        
        /* ä¸€èˆ¬æ¨£å¼ */
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid var(--color-accent); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .thumb-active { border: 3px solid var(--color-primary); opacity: 1 !important; transform: scale(1.05); }
        .cursor-zoom-in { cursor: zoom-in; }
        .cursor-crosshair { cursor: crosshair; }

        /* --- æ»‘å‹•è½‰å ´ CSS --- */
        .slide-stage {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: black;
        }
        .slide-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
            transition: transform 0.8s cubic-bezier(0.25, 1, 0.5, 1); 
            will-change: transform;
        }
        .slide-center { transform: translateX(0%); }
        .slide-left   { transform: translateX(-100%); }
        .slide-right  { transform: translateX(100%); }
        
        .toolbar-hidden { display: none !important; }
        
        /* æ’åºæŒ‰éˆ•æ¿€æ´»ç‹€æ…‹ (ä½¿ç”¨è®Šæ•¸) */
        .sort-btn-active {
            background-color: var(--color-secondary) !important;
            color: white !important;
            border-color: var(--color-secondary) !important;
        }
        
        /* ä¸»é¡Œé¸å–®æ¨£å¼ */
        #theme-menu {
            transform-origin: top right;
            transition: transform 0.2s ease-out, opacity 0.2s ease-out;
        }
    </style>
</head>
<body class="font-sans">

    <!-- é ‚éƒ¨å°èˆª -->
    <nav class="theme-card sticky top-0 z-50 !rounded-none border-b-4 border-kids-yellow">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fa-solid fa-camera-retro text-3xl text-kids-blue"></i>
                <h1 id="app-header-title" class="text-xl md:text-2xl font-bold tracking-wide">å¿«æ¨‚å°å­¸å ‚ç›¸ç°¿</h1>
            </div>
            <div class="flex items-center space-x-3 relative">
                <!-- ä¸»é¡Œåˆ‡æ›æŒ‰éˆ• -->
                <div class="relative">
                    <button onclick="toggleThemeMenu()" class="theme-btn bg-kids-green hover:brightness-110 text-white p-2 w-10 h-10 transition flex items-center justify-center" title="åˆ‡æ›é¢¨æ ¼">
                        <i class="fa-solid fa-palette"></i>
                    </button>
                    <!-- ä¸»é¡Œé¸å–® -->
                    <div id="theme-menu" class="hidden absolute right-0 mt-2 w-40 theme-card !p-0 overflow-hidden z-50">
                        <button onclick="switchTheme('kids')" class="w-full text-left px-4 py-3 hover:bg-gray-100 dark:hover:bg-gray-700 transition border-b border-gray-100 flex items-center">
                            <i class="fa-solid fa-child-reaching w-6 text-yellow-500"></i> æº«é¦¨æ‰‹ç¹ª
                        </button>
                        <button onclick="switchTheme('modern')" class="w-full text-left px-4 py-3 hover:bg-gray-100 dark:hover:bg-gray-700 transition border-b border-gray-100 flex items-center">
                            <i class="fa-solid fa-microchip w-6 text-blue-500"></i> ç¾ä»£ç§‘æŠ€
                        </button>
                        <button onclick="switchTheme('pop')" class="w-full text-left px-4 py-3 hover:bg-gray-100 dark:hover:bg-gray-700 transition flex items-center">
                            <i class="fa-solid fa-bolt w-6 text-red-500"></i> æ™®æ™®è—è¡“
                        </button>
                    </div>
                </div>

                <button onclick="openSettings()" class="theme-btn bg-kids-blue hover:brightness-110 text-white p-2 w-10 h-10 transition">
                    <i class="fa-solid fa-gear"></i>
                </button>
                <button onclick="openHelp()" class="theme-btn bg-kids-red hover:brightness-110 text-white p-2 w-10 h-10 transition">
                    <i class="fa-solid fa-info"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- ä¸»å…§å®¹å€ -->
    <main class="container mx-auto px-4 py-8 flex-grow">
        <!-- è¼‰å…¥ä¸­å‹•ç•« -->
        <div id="loading" class="flex flex-col items-center justify-center mt-20 hidden">
            <div class="loader mb-4"></div>
            <p id="loading-text" class="text-lg font-bold opacity-70 animate-pulse">æ­£åœ¨å»é›²ç«¯æ¬é‹ç…§ç‰‡...</p>
            <p class="text-sm font-bold text-red-500 mt-3 animate-pulse">ç¬¬ä¸€æ¬¡æ•´ç†ç›¸ç°¿æ¯”è¼ƒæ…¢ï¼Œæˆ‘æ­£åœ¨ç¿»ç®±å€’æ«ƒä¸­ï¼Œè«‹ç¨å€™ï¼</p>
        </div>

        <!-- éŒ¯èª¤è¨Šæ¯ / æ­¡è¿ç•«é¢ -->
        <div id="empty-state" class="hidden flex flex-col items-center justify-center mt-10 p-8 theme-card border-4 border-dashed border-kids-yellow max-w-lg mx-auto">
            <i class="fa-solid fa-images text-6xl opacity-30 mb-4"></i>
            <h2 class="text-2xl font-bold mb-2">é‚„æ²’æœ‰çœ‹åˆ°ç›¸ç°¿å–”ï¼</h2>
            <p class="text-center opacity-60 mb-6">è«‹å…ˆé»æ“Šå³ä¸Šè§’çš„è¨­å®š (âš™ï¸) æŒ‰éˆ•<br>è²¼ä¸Šä½ çš„ GAS ç¶²å€ä¾†é€£ç·šã€‚</p>
            <button onclick="openSettings()" class="theme-btn bg-kids-yellow hover:brightness-110 text-gray-800 font-bold py-2 px-6 transition">
                <i class="fa-solid fa-plug mr-2"></i> ç«‹å³é€£ç·š
            </button>
        </div>
        
        <!-- æœå°‹èˆ‡æ’åºæ§åˆ¶åˆ— -->
        <div id="control-bar" class="hidden flex flex-col md:flex-row justify-between items-center mb-6 gap-4 theme-card p-3">
            <div class="flex items-center w-full md:w-1/2 space-x-2">
                <!-- æœå°‹æ¡† -->
                <div class="relative flex-grow">
                    <input type="text" id="search-input" oninput="handleSearch(this.value)" placeholder="ğŸ” æœå°‹ç›¸ç°¿åç¨±..." 
                           class="w-full pl-10 pr-4 py-2 rounded-full border border-gray-300 bg-transparent focus:outline-none focus:ring-2 focus:ring-kids-blue transition">
                    <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 transform -translate-y-1/2 opacity-50"></i>
                </div>
                <!-- åŒæ­¥æŒ‰éˆ• (æ–°åŠŸèƒ½) -->
                <button onclick="syncAlbums()" id="btn-sync" class="theme-btn bg-kids-blue hover:brightness-110 text-white px-4 py-2 flex items-center transition whitespace-nowrap shadow-md" title="æª¢æŸ¥é›²ç«¯æ›´æ–°">
                    <i id="sync-icon" class="fa-solid fa-rotate mr-2"></i>
                    <span class="hidden sm:inline">æª¢æŸ¥æ›´æ–°</span>
                </button>
            </div>
            
            <!-- æ’åºæŒ‰éˆ• -->
            <div class="flex items-center space-x-2 text-sm w-full md:w-auto justify-end overflow-x-auto">
                <span class="font-bold opacity-70 whitespace-nowrap mr-1"><i class="fa-solid fa-arrow-down-short-wide mr-1"></i>æ’åº:</span>
                <button onclick="setSortMode('default')" id="btn-sort-default" class="sort-btn px-3 py-1.5 rounded-full border border-gray-300 opacity-80 hover:opacity-100 hover:bg-gray-100 dark:hover:bg-gray-700 transition whitespace-nowrap sort-btn-active">é è¨­ (æ™‚é–“)</button>
                <button onclick="setSortMode('name')" id="btn-sort-name" class="sort-btn px-3 py-1.5 rounded-full border border-gray-300 opacity-80 hover:opacity-100 hover:bg-gray-100 dark:hover:bg-gray-700 transition whitespace-nowrap">åç¨± (A-Z)</button>
                <button onclick="setSortMode('count')" id="btn-sort-count" class="sort-btn px-3 py-1.5 rounded-full border border-gray-300 opacity-80 hover:opacity-100 hover:bg-gray-100 dark:hover:bg-gray-700 transition whitespace-nowrap">æ•¸é‡ (å¤šåˆ°å°‘)</button>
            </div>
        </div>

        <!-- ç›¸ç°¿åˆ—è¡¨ -->
        <div id="album-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 pb-20">
            <!-- JS å‹•æ…‹æ’å…¥ç›¸ç°¿å¡ç‰‡ -->
        </div>
    </main>

    <!-- ç²¾ç°¡æµ®å‹•é å°¾ (å³ä¸‹è§’) -->
    <div class="fixed bottom-4 right-4 z-40 theme-card !bg-opacity-90 backdrop-blur-sm p-3 text-xs flex flex-col items-end space-y-1 transition hover:opacity-100 opacity-80 group">
        <div class="font-bold flex items-center">
            Made by <a href="https://gsyan888.blogspot.com/" target="_blank" class="text-kids-blue hover:text-blue-600 transition ml-1 underline decoration-2 decoration-kids-yellow">é˜¿å‰›è€å¸«</a>
        </div>
        <div class="flex items-center space-x-1">
            <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" class="flex items-center hover:text-kids-blue transition" title="å‰µç”¨ CC å§“åæ¨™ç¤º-éå•†æ¥­æ€§-ç›¸åŒæ–¹å¼åˆ†äº« 4.0 åœ‹éš› æˆæ¬Šæ¢æ¬¾">
                <i class="fa-brands fa-creative-commons text-base"></i>
                <i class="fa-brands fa-creative-commons-by text-base ml-0.5"></i>
                <i class="fa-brands fa-creative-commons-nc text-base ml-0.5"></i>
                <i class="fa-brands fa-creative-commons-sa text-base ml-0.5"></i>
                <span class="ml-1 font-mono text-[10px]">CC BY-NC-SA 4.0</span>
            </a>
        </div>
        <div class="text-[10px] opacity-60 text-right max-w-[150px] leading-tight">
            æ­¡è¿éå•†æ¥­è½‰è¼‰ï¼Œè«‹è¨»æ˜å‡ºè™•
        </div>
    </div>

    <!-- ç›¸ç‰‡ç€è¦½ Modal -->
    <div id="gallery-modal" class="fixed inset-0 bg-black bg-opacity-95 z-[60] hidden flex flex-col">
        <!-- Header -->
        <div class="flex justify-between items-center p-3 text-white shrink-0 bg-gradient-to-b from-gray-900 to-transparent z-10">
            <h3 id="gallery-title" class="text-xl font-bold truncate">ç›¸ç°¿åç¨±</h3>
            <div class="flex items-center space-x-2 md:space-x-3">
                <button onclick="startPresentationMode(false)" class="flex items-center space-x-1 bg-indigo-600 hover:bg-indigo-500 text-white text-sm px-3 py-2 rounded-full transition shadow-lg border border-indigo-400" title="å…¨è¢å¹•ç°¡å ±/ç•«ç­†">
                    <i class="fa-solid fa-chalkboard-user"></i>
                    <span class="hidden md:inline">ç°¡å ±æ¨¡å¼</span>
                </button>
                <button onclick="downloadAlbumZip()" class="flex items-center space-x-1 bg-gray-700 hover:bg-kids-blue text-white text-sm px-3 py-2 rounded-full transition shadow-lg border border-gray-600" title="æ‰“åŒ…ä¸‹è¼‰">
                    <i class="fa-solid fa-download"></i>
                    <span class="hidden md:inline">æ‰“åŒ…ä¸‹è¼‰</span>
                </button>
                <button onclick="startPresentationMode(true)" class="flex items-center space-x-1 bg-gray-700 hover:bg-kids-yellow hover:text-gray-900 text-white text-sm px-3 py-2 rounded-full transition shadow-lg border border-gray-600" title="å…¨è¢å¹•è‡ªå‹•æ’­æ”¾">
                    <i class="fa-solid fa-play"></i>
                    <span class="hidden md:inline">è‡ªå‹•æ’­æ”¾</span>
                </button>
                <button onclick="closeGallery()" class="bg-gray-700 hover:bg-kids-red w-10 h-10 rounded-full flex items-center justify-center transition border border-gray-600">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>
        </div>

        <!-- Main View Area -->
        <div class="flex-1 flex items-center justify-center overflow-hidden relative group w-full bg-black">
             <button onclick="prevPhoto()" class="absolute left-2 md:left-4 z-20 text-white text-2xl md:text-4xl opacity-50 group-hover:opacity-100 transition bg-black bg-opacity-40 hover:bg-opacity-70 rounded-full w-10 h-10 md:w-14 md:h-14 flex items-center justify-center focus:outline-none">â®</button>
             <button onclick="nextPhoto()" class="absolute right-2 md:right-4 z-20 text-white text-2xl md:text-4xl opacity-50 group-hover:opacity-100 transition bg-black bg-opacity-40 hover:bg-opacity-70 rounded-full w-10 h-10 md:w-14 md:h-14 flex items-center justify-center focus:outline-none">â¯</button>
             
             <div id="main-view" class="w-full h-full flex items-center justify-center p-2">
             </div>
        </div>

        <!-- Thumbnails Strip -->
        <div class="h-24 md:h-28 bg-gray-900 shrink-0 flex items-center p-2 space-x-2 overflow-x-auto hide-scrollbar border-t border-gray-800 z-10" id="thumbnail-strip">
        </div>
    </div>

    <!-- ç°¡å ±/è‡ªå‹•æ’­æ”¾æ¨¡å¼ Modal -->
    <div id="presentation-modal" class="fixed inset-0 bg-black z-[100] hidden flex flex-col select-none touch-none">
        <div class="absolute top-0 left-0 right-0 p-4 z-[130] flex justify-between items-start opacity-0 hover:opacity-100 transition-opacity duration-300">
            <div id="presentation-status" class="bg-black bg-opacity-50 text-white px-3 py-1 rounded-full text-sm backdrop-blur-sm shadow-sm border border-gray-600">
                ç°¡å ±æ¨¡å¼
            </div>
            <button onclick="closePresentationMode()" class="bg-red-500 hover:bg-red-600 text-white rounded-full w-10 h-10 flex items-center justify-center shadow-lg border-2 border-white text-lg transition transform hover:scale-110" title="é€€å‡ºå…¨è¢å¹• (Esc)">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>

        <div id="slide-stage" class="slide-stage relative w-full h-full cursor-none">
            <canvas id="drawing-canvas" class="absolute inset-0 cursor-crosshair z-[110]"></canvas>
        </div>

        <div onclick="prevSlide()" class="absolute left-0 top-0 bottom-0 w-1/6 z-[120] hover:bg-gradient-to-r from-black/30 to-transparent flex items-center justify-start pl-4 opacity-0 hover:opacity-100 cursor-pointer transition">
             <i class="fa-solid fa-chevron-left text-white text-4xl shadow-sm"></i>
        </div>
        <div onclick="nextSlide()" class="absolute right-0 top-0 bottom-0 w-1/6 z-[120] hover:bg-gradient-to-l from-black/30 to-transparent flex items-center justify-end pr-4 opacity-0 hover:opacity-100 cursor-pointer transition">
             <i class="fa-solid fa-chevron-right text-white text-4xl shadow-sm"></i>
        </div>

        <div id="drawing-toolbar" class="absolute bottom-6 left-1/2 transform -translate-x-1/2 bg-gray-900 bg-opacity-90 backdrop-blur-sm rounded-full p-2 flex items-center space-x-2 z-[130] shadow-2xl border border-gray-600 transition-all duration-300">
            <div id="drawing-tools" class="flex items-center space-x-3 px-2 overflow-hidden transition-all duration-300 origin-left">
                <button id="btn-toggle-play" onclick="togglePresentationAutoPlay()" class="text-white hover:text-kids-yellow w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-800 transition" title="æ’­æ”¾/æš«åœ">
                    <i class="fa-solid fa-play"></i>
                </button>
                <div class="w-px h-6 bg-gray-600 mx-1"></div>
                <button class="w-8 h-8 rounded-full bg-red-500 border-2 border-white shadow-md transform hover:scale-110 active:scale-95 transition" onclick="setPenColor('#ef4444')" title="ç´…ç­†"></button>
                <button class="w-8 h-8 rounded-full bg-yellow-400 border-2 border-transparent hover:border-white shadow-md transform hover:scale-110 active:scale-95 transition" onclick="setPenColor('#facc15')" title="é»ƒç­†"></button>
                <button class="w-8 h-8 rounded-full bg-blue-500 border-2 border-transparent hover:border-white shadow-md transform hover:scale-110 active:scale-95 transition" onclick="setPenColor('#3b82f6')" title="è—ç­†"></button>
                <button class="w-8 h-8 rounded-full bg-white border-2 border-transparent hover:border-gray-300 shadow-md transform hover:scale-110 active:scale-95 transition" onclick="setPenColor('#ffffff')" title="ç™½ç­†"></button>
                <div class="w-px h-6 bg-gray-600 mx-1"></div>
                <button onclick="clearCanvas()" class="text-gray-300 hover:text-red-400 w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-800 transition" title="æ¸…é™¤ç•«å¸ƒ">
                    <i class="fa-solid fa-eraser"></i>
                </button>
            </div>
            <button onclick="toggleToolbar()" class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-800 hover:bg-gray-700 text-white border border-gray-600 shadow-md transition">
                <i id="toolbar-icon" class="fa-solid fa-chevron-right"></i>
            </button>
        </div>
    </div>

    <!-- å…¨è¢å¹•ç€è¦½ Modal -->
    <div id="fullscreen-modal" class="fixed inset-0 bg-black z-[90] hidden flex items-center justify-center cursor-zoom-out" onclick="closeFullscreen()">
        <img id="fullscreen-image" src="" class="max-w-full max-h-full object-contain" alt="Full Screen View">
        <button class="absolute top-4 right-4 text-white text-4xl opacity-70 hover:opacity-100 p-2">&times;</button>
    </div>

    <!-- Widget å®¹å™¨ -->
    <div id="widget-container" class="hidden w-full h-full p-2"></div>

    <!-- è¨­å®š Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[70] hidden flex items-center justify-center p-4">
        <div class="theme-card max-w-md w-full p-6 relative border-4 border-kids-blue">
            <button onclick="closeSettings()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <i class="fa-solid fa-xmark text-2xl"></i>
            </button>
            
            <h2 class="text-2xl font-bold text-kids-blue mb-4 flex items-center">
                <i class="fa-solid fa-gear mr-2"></i> ç³»çµ±è¨­å®š
            </h2>
            
            <div class="mb-4">
                <label class="block text-sm font-bold mb-2 opacity-80">GAS Web App URL (Script ID)</label>
                <div class="relative">
                    <input type="password" id="gas-url-input" class="shadow appearance-none border rounded-xl w-full py-3 px-4 leading-tight focus:outline-none focus:ring-2 focus:ring-kids-blue bg-transparent" placeholder="è«‹è²¼ä¸Š https://script.google.com/...">
                    <button onclick="toggleVisibility()" class="absolute right-3 top-3 text-gray-400 hover:text-gray-600">
                        <i class="fa-solid fa-eye"></i>
                    </button>
                </div>
            </div>

            <div class="mb-6">
                <label class="block text-sm font-bold mb-2 opacity-80">ç¶²é æ¨™é¡Œ (App Title)</label>
                <input type="text" id="app-title-input" class="shadow appearance-none border rounded-xl w-full py-3 px-4 leading-tight focus:outline-none focus:ring-2 focus:ring-kids-blue bg-transparent">
            </div>

            <div class="mb-6 p-4 bg-gray-50 dark:bg-gray-700 rounded-xl border border-gray-200 dark:border-gray-600">
                <h3 class="font-bold mb-2 opacity-80">ğŸ“¤ åˆ†äº« / åµŒå…¥</h3>
                <div class="flex space-x-2 mb-3">
                    <button onclick="generateShareLink()" class="flex-1 bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-2 rounded-lg text-sm transition"><i class="fa-solid fa-link mr-1"></i> åˆ†äº«é€£çµ</button>
                    <button onclick="generateEmbedCode()" class="flex-1 bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-2 rounded-lg text-sm transition"><i class="fa-solid fa-code mr-1"></i> åµŒå…¥å­¸æ ¡ç¶²é </button>
                </div>
                <div id="share-result" class="hidden text-center space-y-3">
                    <img id="qr-code-img" class="mx-auto border-4 border-white shadow-md rounded-lg" width="120" src="">
                    <input type="text" id="share-url-output" readonly class="w-full border text-xs p-2 rounded bg-white text-gray-600">
                    <button onclick="copyShareUrl()" class="bg-gray-200 text-xs px-2 py-1 rounded">è¤‡è£½é€£çµ</button>
                </div>
                <div id="embed-result" class="hidden text-left space-y-2 mt-2">
                    <label class="text-xs font-bold block">é¡¯ç¤ºæ•¸é‡ (é è¨­16æœ¬)</label>
                    <input type="number" id="embed-limit" value="16" min="1" max="50" class="border rounded p-1 text-sm w-20 bg-white" onchange="generateEmbedCode()">
                    <label class="text-xs font-bold block">åµŒå…¥èªæ³• (Iframe)</label>
                    <textarea id="embed-code-output" readonly rows="4" class="w-full border text-xs p-2 rounded bg-gray-800 text-green-400 font-mono focus:outline-none"></textarea>
                    <button onclick="copyEmbedCode()" class="w-full bg-gray-200 hover:bg-gray-300 text-xs py-2 rounded font-bold"><i class="fa-solid fa-copy"></i> è¤‡è£½èªæ³•</button>
                    <p class="text-[10px] text-gray-500">æç¤ºï¼šé¡¯ç¤ºå…©æ’ç›¸ç°¿ï¼Œå»ºè­°åµŒå…¥é«˜åº¦è¨­ç‚º 540pxã€‚</p>
                </div>
            </div>

            <div class="flex justify-between items-center">
                <button onclick="resetSettings()" class="text-red-500 hover:text-red-700 font-bold py-2 px-4 rounded transition">
                    <i class="fa-solid fa-trash-can mr-1"></i> æ¸…é™¤è¨­å®š
                </button>
                <button onclick="saveSettings()" class="bg-kids-blue hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-full shadow-lg transition transform hover:scale-105">
                    å„²å­˜ä¸¦é€£ç·š
                </button>
            </div>
        </div>
    </div>

    <!-- ä¸Šå‚³ Modal -->
    <div id="upload-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[70] hidden flex items-center justify-center p-4">
        <div class="theme-card max-w-md w-full p-6 relative border-4 border-kids-green">
             <button onclick="closeUploadModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark text-2xl"></i></button>
             <h2 class="text-2xl font-bold text-kids-green mb-4"><i class="fa-solid fa-cloud-arrow-up mr-2"></i> ä¸Šå‚³æ–°ç…§ç‰‡</h2>
             <div class="mb-4">
                 <label class="block text-sm font-bold mb-2 opacity-80">ç›¸ç°¿åç¨±</label>
                 <input type="text" id="upload-album-name" list="album-options" class="shadow border rounded-xl w-full py-2 px-3 focus:outline-none focus:ring-2 focus:ring-kids-green bg-transparent">
                 <datalist id="album-options"></datalist>
             </div>
             <div class="mb-4">
                 <label class="block text-sm font-bold mb-2 opacity-80">é¸æ“‡åœ–ç‰‡</label>
                 <input type="file" id="file-input" accept="image/*" class="w-full text-sm opacity-60 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-kids-green file:text-white hover:file:bg-green-600"/>
             </div>
             <canvas id="compress-canvas" style="display:none;"></canvas>
             <button onclick="processAndUpload()" id="upload-btn" class="w-full bg-kids-green hover:bg-green-600 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition">é–‹å§‹ä¸Šå‚³</button>
        </div>
    </div>

    <!-- èªªæ˜ Modal -->
    <div id="help-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[80] hidden flex items-center justify-center p-4">
        <div class="theme-card max-w-2xl w-full p-6 relative border-4 border-kids-red h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-kids-red"><i class="fa-solid fa-book-open mr-2"></i> ä½¿ç”¨èªªæ˜èˆ‡ç¨‹å¼ç¢¼</h2>
                <button onclick="closeHelp()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
            <div class="flex-1 overflow-y-auto bg-gray-50 dark:bg-gray-800 p-4 rounded-xl border border-gray-200 dark:border-gray-700 text-sm">
                <h3 class="font-bold text-lg mb-2">1. éƒ¨ç½²æ­¥é©Ÿ</h3>
                <ul class="list-disc list-inside mb-4 space-y-1 text-gray-600 dark:text-gray-300">
                    <li>å»ºç«‹ä¸€å€‹æ–°çš„ Google Sheetã€‚</li>
                    <li class="font-bold text-red-500">é‡è¦ï¼šè«‹å°‡è©¦ç®—è¡¨æ‰€åœ¨çš„ Google Drive è³‡æ–™å¤¾è¨­å®šå…±ç”¨ï¼Œæ¬Šé™è¨­ç‚ºã€ŒçŸ¥é“é€£çµçš„ä»»ä½•äººã€çš†å¯ã€Œæª¢è¦–ã€ã€‚</li>
                    <li>é»æ“Šã€Œæ“´å……åŠŸèƒ½ã€ > ã€ŒApps Scriptã€ã€‚</li>
                    <li>å°‡ä¸‹æ–¹ç¨‹å¼ç¢¼å®Œå…¨è¦†è“‹åˆ°ç·¨è¼¯å™¨ä¸­ã€‚</li>
                    <li>é»æ“Šã€Œéƒ¨ç½²ã€ > ã€Œæ–°å¢éƒ¨ç½²ã€ > é¡å‹é¸ã€Œç¶²é æ‡‰ç”¨ç¨‹å¼ã€ã€‚</li>
                    <li><b>èª°å¯ä»¥å­˜å–ï¼šå‹™å¿…é¸æ“‡ã€Œä»»ä½•äººã€</b>ã€‚</li>
                    <li>è¤‡è£½å¾—åˆ°çš„ç¶²å€ï¼Œè²¼åˆ°æœ¬ç¶²é çš„è¨­å®šä¸­ã€‚</li>
                </ul>
                <div class="flex justify-between items-end mb-2">
                    <h3 class="font-bold text-lg">2. GAS ç¨‹å¼ç¢¼</h3>
                    <button onclick="copyCode()" class="bg-gray-700 hover:bg-gray-900 text-white text-xs py-1 px-3 rounded flex items-center"><i class="fa-solid fa-copy mr-1"></i> è¤‡è£½ç¨‹å¼ç¢¼</button>
                </div>
                <pre id="code-block" class="bg-gray-800 text-green-400 p-4 rounded-lg overflow-x-auto text-xs font-mono"></pre>
            </div>
        </div>
    </div>

    <!-- JavaScript é‚è¼¯ -->
    <script>
        // --- IndexedDB Helper ---
        // è§£æ±º localStorage å®¹é‡é™åˆ¶ (5MB)ï¼ŒIndexedDB å¯æ”¯æ´æ•¸ GB
        let dbName = 'HappySchoolDB';
        const storeName = 'albumsStore';
        let dbPromise = null;

        function initDB(suffix = '') {
            if (suffix) { const shortId = suffix.length > 10 ? suffix.slice(-10) : suffix; dbName = `HappySchoolDB_${shortId}`; }
            dbPromise = new Promise((resolve, reject) => {
                const request = indexedDB.open(dbName, 1);
                request.onupgradeneeded = (e) => { const db = e.target.result; if (!db.objectStoreNames.contains(storeName)) db.createObjectStore(storeName); };
                request.onsuccess = (e) => resolve(e.target.result);
                request.onerror = (e) => reject(e.target.error);
            });
        }

        const idb = {
            async get(key) { if(!dbPromise) initDB(); try { const db = await dbPromise; return new Promise((resolve, reject) => { const tx = db.transaction(storeName, 'readonly'); const req = tx.objectStore(storeName).get(key); req.onsuccess = () => resolve(req.result); req.onerror = () => reject(req.error); }); } catch(e){ return null; } },
            async set(key, val) { if(!dbPromise) initDB(); try { const db = await dbPromise; const tx = db.transaction(storeName, 'readwrite'); tx.objectStore(storeName).put(val, key); } catch(e){} },
            async clear() { if(!dbPromise) initDB(); try { const db = await dbPromise; const tx = db.transaction(storeName, 'readwrite'); tx.objectStore(storeName).clear(); } catch(e){} }
        };

        // --- å…¨åŸŸè®Šæ•¸ ---
        let gasUrl = localStorage.getItem('gas_app_url') || "";
        let appTitle = localStorage.getItem('app_title') || "å¿«æ¨‚å°å­¸å ‚ç›¸ç°¿";
        let albumsData = []; // åŸå§‹è³‡æ–™
        let currentAlbumPhotos = [];
        let currentPhotoIndex = 0;
        
        // æœå°‹èˆ‡æ’åºè®Šæ•¸
        let searchKeyword = "";
        let currentSortMode = "default"; // default, name, count
        
        // Gallery è‡ªå‹•æ’­æ”¾
        let playInterval = null;

        // ç°¡å ±æ¨¡å¼è®Šæ•¸
        let isDrawing = false;
        let presentationCtx = null;
        let currentPenColor = '#ef4444'; 
        let isToolbarExpanded = true;
        let isPresentationPlaying = false; // ç°¡å ±æ¨¡å¼ä¸‹çš„è‡ªå‹•æ’­æ”¾ç‹€æ…‹
        let presentationTimer = null;
        
        // Widget æ¨¡å¼è®Šæ•¸
        let isWidgetMode = false;
        let widgetLimit = 16; 
        let isStandaloneMode = false;

        // GAS Code String (å„ªåŒ–ç‰ˆï¼šä¿®å¾©æœå‹™éŒ¯èª¤)
        const gasCodeString = `/**
 * å¿«æ¨‚å°å­¸å ‚ãƒ»é›²ç«¯ç›¸ç°¿ - å¾Œç«¯ API (å„ªåŒ–ç‰ˆ)
 */

const DB_SHEET_NAME = "ç›¸ç‰‡ä¸Šå‚³ç´€éŒ„";
const DB_HEADERS = ["æ™‚é–“æˆ³è¨˜", "ç›¸ç°¿åç¨± (è³‡æ–™å¤¾)", "æª”æ¡ˆåç¨±", "æª”æ¡ˆé¡å‹", "æª”æ¡ˆ ID", "é è¦½é€£çµ"];

function doGet(e) {
  const params = e.parameter;
  const action = params.action;
  let result = {};

  try {
    if (action === "getAlbums") {
      result = getAlbumData();
    } else if (action === "shortenUrl") {
      result = proxyShortenUrl(params.longUrl);
    } else {
      result = { status: "error", message: "æœªçŸ¥çš„è«‹æ±‚å‹•ä½œ" };
    }
  } catch (err) {
    result = { status: "error", message: err.toString() };
  }

  return ContentService.createTextOutput(JSON.stringify(result))
    .setMimeType(ContentService.MimeType.JSON);
}

function doPost(e) {
  let result = {};
  try {
    initDatabase();
    const postData = JSON.parse(e.postData.contents);
    const albumName = postData.albumName; 
    const fileName = postData.fileName;
    const base64Data = postData.image;

    const rootFolder = getRootFolder();
    let albumFolder;
    const folders = rootFolder.getFoldersByName(albumName);
    if (folders.hasNext()) {
      albumFolder = folders.next();
    } else {
      albumFolder = rootFolder.createFolder(albumName);
    }

    const contentType = base64Data.substring(5, base64Data.indexOf(';'));
    const bytes = Utilities.base64Decode(base64Data.substring(base64Data.indexOf(',') + 1));
    const blob = Utilities.newBlob(bytes, contentType, fileName);
    const file = albumFolder.createFile(blob);
    
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);

    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName(DB_SHEET_NAME);
    // ä½¿ç”¨å»ºæ§‹çš„ URL
    const fileUrl = "https://lh3.googleusercontent.com/d/" + file.getId() + "=s800";

    sheet.appendRow([new Date(), albumName, fileName, contentType, file.getId(), fileUrl]);
    result = { status: "success", message: "ä¸Šå‚³æˆåŠŸ", fileUrl: fileUrl };
  } catch (err) {
    result = { status: "error", message: err.toString() };
  }
  return ContentService.createTextOutput(JSON.stringify(result)).setMimeType(ContentService.MimeType.JSON);
}

function getAlbumData() {
  const rootFolder = getRootFolder();
  const albums = [];
  const subFolders = rootFolder.getFolders();
  
  while (subFolders.hasNext()) {
    const folder = subFolders.next();
    const folderName = folder.getName();
    const folderId = folder.getId();
    const photos = [];
    
    try {
        const files = folder.getFiles();
        while (files.hasNext()) {
          const file = files.next();
          const mimeType = file.getMimeType();
          
          if (mimeType.startsWith('image/') || mimeType.startsWith('video/')) {
            // å„ªåŒ–ï¼šæ‰‹å‹•å»ºæ§‹é è¦½èˆ‡ä¸‹è¼‰ URLï¼Œé¿å…å‘¼å« Drive API å°è‡´é…é¡éŒ¯èª¤
            const fileId = file.getId();
            const url = "https://lh3.googleusercontent.com/d/" + fileId + "=s800";
            // é—œéµä¿®æ”¹ï¼šæ‰‹å‹•çµ„åˆä¸‹è¼‰é€£çµï¼Œå–ä»£ file.getDownloadUrl()
            const downloadUrl = "https://drive.google.com/uc?export=download&id=" + fileId;

            photos.push({
              id: fileId,
              name: file.getName(),
              type: mimeType,
              url: url, 
              downloadUrl: downloadUrl 
            });
          }
        }
    } catch (e) {
        console.error("Error reading folder: " + folderName, e);
        // å¿½ç•¥å–®ä¸€è³‡æ–™å¤¾éŒ¯èª¤ï¼Œç¹¼çºŒè®€å–å…¶ä»–è³‡æ–™å¤¾
    }
    
    if (photos.length > 0) {
      albums.push({
        id: folderId,
        name: folderName,
        cover: photos[0].url,
        photos: photos
      });
    }
  }
  return { status: "success", data: albums };
}

function getRootFolder() {
  const ssId = SpreadsheetApp.getActiveSpreadsheet().getId();
  const file = DriveApp.getFileById(ssId);
  const parents = file.getParents();
  if (parents.hasNext()) {
    return parents.next();
  } else {
    throw new Error("æ‰¾ä¸åˆ°è©¦ç®—è¡¨æ‰€åœ¨çš„çˆ¶è³‡æ–™å¤¾");
  }
}

function initDatabase() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let sheet = ss.getSheetByName(DB_SHEET_NAME);
  if (!sheet) {
    sheet = ss.insertSheet(DB_SHEET_NAME);
    sheet.appendRow(DB_HEADERS);
  }
}

function proxyShortenUrl(longUrl) {
  if (!longUrl) return { status: "error", message: "ç„¡æ•ˆçš„ç¶²å€" };
  const apiUrl = \`https://is.gd/create.php?format=json&url=\${encodeURIComponent(longUrl)}\`;
  try {
    const response = UrlFetchApp.fetch(apiUrl, { muteHttpExceptions: true });
    const json = JSON.parse(response.getContentText());
    if (json.shorturl) {
      return { status: "success", shortUrl: json.shorturl };
    } else {
      return { status: "error", message: "ç¸®ç¶²å€å¤±æ•—", details: json };
    }
  } catch (e) {
    return { status: "error", message: "API é€£ç·šå¤±æ•—", error: e.toString() };
  }
}`; 

        // --- Data Compression Helpers ---
        // å£“ç¸®ï¼šç§»é™¤é‡è¤‡çš„ URL å­—ä¸²ï¼Œåªä¿ç•™ ID å’Œå¿…è¦æ¬„ä½
        function compressAlbums(albums) {
            return albums.map(album => ({
                i: album.id,
                n: album.name,
                c: album.cover, // ä¿ç•™å°é¢åœ–å®Œæ•´ URL (å› ç‚ºå¯èƒ½ä¸æ˜¯ç¬¬ä¸€å¼µåœ–)
                p: album.photos.map(p => ({
                    i: p.id,
                    n: p.name,
                    t: p.type
                    // ç§»é™¤ url å’Œ downloadUrlï¼Œé€™ä½”äº†çµ•å¤§éƒ¨åˆ†ç©ºé–“
                }))
            }));
        }

        // è§£å£“ç¸®ï¼šæ ¹æ“š ID é‡å»ºå®Œæ•´çš„ URL
        function decompressAlbums(minified) {
            if (!minified || !Array.isArray(minified)) return [];
            // ç°¡å–®æª¢æŸ¥æ˜¯å¦ç‚ºèˆŠç‰ˆè³‡æ–™ (è‹¥ç¬¬ä¸€ç­†è³‡æ–™æœ‰ photos å±¬æ€§å‰‡ç‚ºèˆŠç‰ˆ)
            if (minified.length > 0 && minified[0].photos) {
                return minified; // èˆŠç‰ˆè³‡æ–™ç›´æ¥å›å‚³
            }

            return minified.map(a => ({
                id: a.i,
                name: a.n,
                cover: a.c,
                photos: a.p.map(p => ({
                    id: p.i,
                    name: p.n,
                    type: p.t,
                    url: `https://lh3.googleusercontent.com/d/${p.i}=s800`,
                    downloadUrl: `https://drive.google.com/uc?export=download&id=${p.i}`
                }))
            }));
        }
        
        function getScriptId(url) { if (!url) return ''; const match = url.match(/\/s\/([a-zA-Z0-9-_]+)\//); return match ? match[1] : ''; }

        // --- åˆå§‹åŒ– ---
        window.onload = async function() {
            // è¼‰å…¥ä¸»é¡Œ
            const savedTheme = localStorage.getItem('app_theme') || 'kids';
            switchTheme(savedTheme);

            document.getElementById('code-block').innerText = gasCodeString;
            const urlParams = new URLSearchParams(window.location.search);
            
            // 1. åµæ¸¬ Widget æ¨¡å¼
            if (urlParams.get('mode') === 'widget') {
                isWidgetMode = true;
                document.body.classList.add('widget-mode');
                const limitParam = urlParams.get('limit');
                widgetLimit = limitParam ? parseInt(limitParam, 10) : 16;
                const container = document.getElementById('widget-container');
                container.classList.remove('hidden');
                // ä¿®æ”¹å°å·¥å…·æ¨¡å¼çš„è¼‰å…¥æ–‡å­—
                container.innerHTML = `<div class="w-full h-full flex flex-col justify-center items-center"><div class="loader mb-2"></div><div class="text-gray-500 font-bold text-sm bg-white/80 px-3 py-1 rounded-full backdrop-blur-sm shadow-sm mb-1">ç›¸ç°¿è®€å–ä¸­...</div><div class="text-gray-600 text-xs bg-white/80 px-2 py-0.5 rounded backdrop-blur-sm font-bold">ç¬¬ä¸€æ¬¡æ•´ç†ç›¸ç°¿æ¯”è¼ƒæ…¢ï¼Œæˆ‘æ­£åœ¨ç¿»ç®±å€’æ«ƒä¸­ï¼Œè«‹ç¨å€™ï¼</div></div>`;
            }
            
            const paramTitle = urlParams.get('title');
            const config = urlParams.get('config');
            
            if (paramTitle) {
                appTitle = decodeURIComponent(paramTitle);
                // åªæœ‰æ²’å¸¶åƒæ•¸æ™‚æ‰ä¾è³´ LocalStorage
                if(!config) localStorage.setItem('app_title', appTitle);
            } else if (!config) {
                appTitle = localStorage.getItem('app_title') || "å¿«æ¨‚å°å­¸å ‚ç›¸ç°¿";
            }
            updateAppTitleUI(appTitle);

            if (config) {
                try {
                    const decodedUrl = atob(config);
                    if (decodedUrl.startsWith('http')) {
                        gasUrl = decodedUrl;
                        isStandaloneMode = true; 
                        
                        // åªæœ‰åœ¨é Widget æ¨¡å¼ä¸”ä½¿ç”¨è€…æ˜ç¢ºæƒ³å„²å­˜æ™‚æ‰æ›´æ–° LocalStorage
                        // é€™è£¡ç‚ºäº†é˜²æ­¢å¹²æ“¾ï¼Œå¦‚æœæœ‰ configï¼Œæˆ‘å€‘å°±ä¸è‡ªå‹•æ›´æ–° LocalStorage çš„ global key
                        if (!isWidgetMode) {
                            Swal.fire({ icon: 'success', title: 'å·²è¼‰å…¥æŒ‡å®šç›¸ç°¿', text: 'ä½¿ç”¨åˆ†äº«é€£çµæ¨¡å¼ (ä¸å½±éŸ¿æœ¬æ©Ÿå…¶ä»–è¨­å®š)', timer: 1500, showConfirmButton: false });
                        }
                    }
                } catch (e) { console.error("Config decode failed", e); }
            } else {
                gasUrl = localStorage.getItem('gas_app_url') || "";
            }

            document.getElementById('app-title-input').value = appTitle;
            
            // --- æ ¸å¿ƒä¿®æ”¹ï¼šæœ¬åœ°å¿«å–å„ªå…ˆé‚è¼¯ (è®€å– IndexedDB) ---
            if (gasUrl) {
                document.getElementById('gas-url-input').value = gasUrl;
                const scriptId = getScriptId(gasUrl);
                initDB(scriptId); // é€™è£¡æœƒå»ºç«‹ HappySchoolDB_XXXXXX
                
                // å˜—è©¦è®€å–æœ¬åœ°å¿«å–
                const cachedData = await idb.get('cached_albums_min_v1'); // ä½¿ç”¨æ–° Key
                if (cachedData) {
                    console.log("Loading from IndexedDB cache...");
                    try {
                        // å¦‚æœå­˜å…¥çš„æ˜¯å­—ä¸²å‰‡éœ€è¦ parseï¼Œå¦‚æœæ˜¯ç‰©ä»¶å‰‡ç›´æ¥ä½¿ç”¨
                        const minifiedData = (typeof cachedData === 'string') ? JSON.parse(cachedData) : cachedData;
                        albumsData = decompressAlbums(minifiedData);
                        
                        if (isWidgetMode) {
                            renderWidget(albumsData);
                        } else {
                            renderAlbums(albumsData);
                            document.getElementById('control-bar').classList.remove('hidden');
                        }
                        updateUploadOptions(albumsData);
                        document.getElementById('loading').classList.add('hidden'); 
                    } catch (e) {
                        console.error("Cache corrupted, fetching fresh data...", e);
                        fetchAlbums(); 
                    }
                } else {
                    fetchAlbums();
                }
            } else if (!isWidgetMode) {
                document.getElementById('empty-state').classList.remove('hidden');
            }
            
            initPresentationCanvas();

            // é»æ“Šå¤–éƒ¨é—œé–‰ä¸»é¡Œé¸å–®
            document.addEventListener('click', function(e) {
                const menu = document.getElementById('theme-menu');
                const btn = e.target.closest('button[title="åˆ‡æ›é¢¨æ ¼"]');
                if (!menu.classList.contains('hidden') && !btn && !menu.contains(e.target)) {
                    menu.classList.add('hidden');
                }
            });
        };

        // --- ä¸»é¡Œåˆ‡æ›é‚è¼¯ ---
        function toggleThemeMenu() {
            document.getElementById('theme-menu').classList.toggle('hidden');
        }

        function switchTheme(themeName) {
            document.documentElement.setAttribute('data-theme', themeName);
            localStorage.setItem('app_theme', themeName);
            
            // å¦‚æœæ˜¯ Modern ä¸»é¡Œï¼Œåˆ‡æ› Tailwind çš„ Dark Mode
            if (themeName === 'modern') {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
            
            // éš±è—é¸å–®
            document.getElementById('theme-menu').classList.add('hidden');
        }

        function updateAppTitleUI(title) {
            document.title = title + " ğŸ“¸";
            document.getElementById('app-header-title').innerText = title;
        }

        async function fetchAlbums(isSync = false) {
            const loading = document.getElementById('loading');
            const emptyState = document.getElementById('empty-state');
            const albumGrid = document.getElementById('album-grid');
            const controlBar = document.getElementById('control-bar');
            
            if (!isSync && !isWidgetMode && albumsData.length === 0) {
                loading.classList.remove('hidden');
                emptyState.classList.add('hidden');
                controlBar.classList.add('hidden'); 
                albumGrid.innerHTML = ''; 
            } else if (isWidgetMode && albumsData.length === 0) {
                 // widget mode loading is handled in html structure or already present
            }

            try {
                const response = await fetch(`${gasUrl}?action=getAlbums`);
                const json = await response.json();
                if (json.status === 'success') {
                    const freshData = json.data;
                    
                    if (isSync) {
                        return freshData;
                    }

                    // ä¸€èˆ¬è¼‰å…¥æ¨¡å¼
                    albumsData = freshData;
                    // --- ä¿®æ­£ï¼šå¯«å…¥ IndexedDB ---
                    try {
                        const minified = compressAlbums(albumsData);
                        await idb.set('cached_albums_min_v1', minified);
                    } catch (e) {
                        console.warn("IndexedDB å¯«å…¥å¤±æ•—", e);
                    }
                    // --------------------------
                    
                    if (isWidgetMode) {
                        renderWidget(albumsData);
                    } else {
                        controlBar.classList.remove('hidden');
                        filterAndSortAlbums(); 
                        updateUploadOptions(albumsData);
                        document.getElementById('empty-state').classList.add('hidden');
                    }
                } else {
                    throw new Error(json.message || "æœªçŸ¥éŒ¯èª¤");
                }
            } catch (error) {
                console.error(error);
                if (isWidgetMode) {
                     document.getElementById('widget-container').innerHTML = '<div class="text-white p-4 text-center">ç„¡æ³•è¼‰å…¥ç›¸ç°¿<br>è«‹æª¢æŸ¥ GAS ç¶²å€</div>';
                } else if (!isSync) {
                    Swal.fire('è®€å–å¤±æ•—', 'ç„¡æ³•é€£æ¥åˆ° GASï¼Œè«‹æª¢æŸ¥ç¶²å€æˆ–æ¬Šé™è¨­å®šã€‚', 'error');
                    emptyState.classList.remove('hidden');
                } else {
                    throw error; 
                }
            } finally {
                loading.classList.add('hidden');
            }
        }

        // --- åŒæ­¥èˆ‡æ¯”å°é‚è¼¯ ---
        async function syncAlbums() {
            const btn = document.getElementById('btn-sync');
            const icon = document.getElementById('sync-icon');
            
            btn.disabled = true;
            icon.classList.add('fa-spin');
            
            try {
                const freshData = await fetchAlbums(true); 
                
                const oldIds = new Set(albumsData.map(a => a.id));
                const newIds = new Set(freshData.map(a => a.id));
                const oldMap = new Map(albumsData.map(a => [a.id, a]));
                
                let addedCount = 0;
                let removedCount = 0;
                let modifiedCount = 0;
                
                freshData.forEach(album => {
                    if (!oldIds.has(album.id)) {
                        addedCount++;
                    } else {
                        const oldAlbum = oldMap.get(album.id);
                        if (oldAlbum && oldAlbum.photos.length !== album.photos.length) {
                            modifiedCount++;
                        }
                    }
                });
                
                albumsData.forEach(album => {
                    if (!newIds.has(album.id)) {
                        removedCount++;
                    }
                });
                
                albumsData = freshData;
                // --- ä¿®æ­£ï¼šå¯«å…¥ IndexedDB ---
                try {
                    const minified = compressAlbums(albumsData);
                    await idb.set('cached_albums_min_v1', minified);
                } catch (e) {
                    console.warn("IndexedDB å¯«å…¥å¤±æ•—", e);
                }
                // --------------------------
                
                filterAndSortAlbums();
                updateUploadOptions(albumsData);
                
                if (addedCount === 0 && removedCount === 0 && modifiedCount === 0) {
                    Swal.fire({
                        icon: 'info',
                        title: 'è³‡æ–™å·²æ˜¯æœ€æ–°',
                        text: 'é›²ç«¯ç›¸ç°¿æ²’æœ‰è®Šå‹•ã€‚',
                        timer: 1500,
                        showConfirmButton: false
                    });
                } else {
                    Swal.fire({
                        icon: 'success',
                        title: 'åŒæ­¥å®Œæˆï¼',
                        html: `
                            <ul class="text-left text-sm space-y-1">
                                <li><span class="text-green-600 font-bold">ï¼‹ æ–°å¢ï¼š</span> ${addedCount} æœ¬ç›¸ç°¿</li>
                                <li><span class="text-blue-600 font-bold">â†» æ›´æ–°ï¼š</span> ${modifiedCount} æœ¬ç›¸ç°¿å…§å®¹</li>
                                <li><span class="text-red-500 font-bold">ï¼ ç§»é™¤ï¼š</span> ${removedCount} æœ¬ç›¸ç°¿</li>
                            </ul>
                        `
                    });
                }

            } catch (err) {
                Swal.fire('åŒæ­¥å¤±æ•—', 'ç„¡æ³•é€£ç·šåˆ°é›²ç«¯ç¡¬ç¢Ÿ', 'error');
            } finally {
                btn.disabled = false;
                icon.classList.remove('fa-spin');
            }
        }

        // --- æœå°‹èˆ‡æ’åºé‚è¼¯ ---
        function handleSearch(keyword) {
            searchKeyword = keyword.toLowerCase();
            filterAndSortAlbums();
        }

        function setSortMode(mode) {
            currentSortMode = mode;
            document.querySelectorAll('.sort-btn').forEach(btn => btn.classList.remove('sort-btn-active'));
            document.getElementById(`btn-sort-${mode}`).classList.add('sort-btn-active');
            filterAndSortAlbums();
        }

        function filterAndSortAlbums() {
            let filtered = [...albumsData]; 

            if (searchKeyword) {
                filtered = filtered.filter(album => album.name.toLowerCase().includes(searchKeyword));
            }

            if (currentSortMode === 'name') {
                filtered.sort((a, b) => a.name.localeCompare(b.name, 'zh-Hant'));
            } else if (currentSortMode === 'count') {
                filtered.sort((a, b) => b.photos.length - a.photos.length);
            } 

            renderAlbums(filtered);
        }

        function renderAlbums(albums) {
            const grid = document.getElementById('album-grid');
            grid.innerHTML = ''; 
            
            if (albums.length === 0) {
                grid.innerHTML = `<div class="col-span-full text-center opacity-60 py-10">
                    <i class="fa-solid fa-face-sad-tear text-4xl mb-2 opacity-50"></i><br>
                    æ‰¾ä¸åˆ°ç¬¦åˆçš„ç›¸ç°¿...
                </div>`;
                return;
            }

            albums.forEach(album => {
                const card = document.createElement('div');
                card.className = "theme-card overflow-hidden card-hover cursor-pointer group border-transparent hover:border-kids-yellow";
                card.onclick = () => openGallery(album.id);
                const coverImg = album.cover || 'https://via.placeholder.com/400x300?text=No+Image';
                card.innerHTML = `
                    <div class="relative h-48 overflow-hidden bg-gray-200">
                        <img src="${coverImg}" class="w-full h-full object-cover group-hover:scale-110 transition duration-500" loading="lazy">
                        <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition"></div>
                    </div>
                    <div class="p-4">
                        <h3 class="font-bold text-lg truncate" title="${album.name}"><i class="fa-regular fa-folder-open mr-2 text-kids-yellow"></i>${album.name}</h3>
                        <p class="text-sm opacity-60 mt-1">${album.photos.length} å¼µç…§ç‰‡</p>
                    </div>
                `;
                grid.appendChild(card);
            });
        }
        
        // --- Widget Render Logic (é›™æ’æ¨¡å¼) ---
        function renderWidget(albums) {
            const container = document.getElementById('widget-container');
            container.classList.remove('hidden');
            container.innerHTML = '';

            const targetAlbums = albums.slice(0, widgetLimit);

            if (targetAlbums.length === 0) {
                container.innerHTML = '<div class="text-center w-full text-gray-500">æš«ç„¡ç›¸ç°¿</div>';
                return;
            }

            const halfIndex = Math.ceil(targetAlbums.length / 2);
            const row1Albums = targetAlbums.slice(0, halfIndex);
            const row2Albums = targetAlbums.slice(halfIndex);

            const createMarqueeRow = (items) => {
                if (items.length === 0) return null;

                const wrapper = document.createElement('div');
                wrapper.className = 'marquee-wrapper flex-1 overflow-hidden relative flex items-center bg-white/50 dark:bg-black/50 backdrop-blur-sm rounded-xl mb-2 last:mb-0';
                
                const track = document.createElement('div');
                track.className = 'marquee-track flex w-max animate-marquee';
                
                let contentHTML = '';
                items.forEach(album => {
                    let coverUrl = album.cover || '';
                    if (coverUrl.includes('=s800')) coverUrl = coverUrl.replace('=s800', '=s400');
                    else if (coverUrl.includes('googleusercontent.com')) coverUrl += '=s400';

                    // é—œéµï¼šç”¢ç”Ÿé€£çµæ™‚ï¼Œç¢ºä¿ä¹Ÿæ˜¯ä½¿ç”¨å¸¶æœ‰ config çš„å®Œæ•´ç¶²å€ï¼Œç¶­æŒéš”é›¢ç‹€æ…‹
                    const config = btoa(gasUrl);
                    const fullUrl = `${window.location.pathname}?title=${encodeURIComponent(appTitle)}&config=${config}`;
                    
                    contentHTML += `
                    <div class="widget-card group" onclick="window.open('${fullUrl}', '_blank')">
                        <div class="relative h-48 overflow-hidden bg-gray-200">
                            <img src="${coverUrl}" class="w-full h-full object-cover group-hover:scale-110 transition duration-500" loading="lazy" alt="${album.name}">
                            <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition flex items-center justify-center">
                                <i class="fa-solid fa-arrow-up-right-from-square text-white opacity-0 group-hover:opacity-100 text-2xl drop-shadow-md"></i>
                            </div>
                            <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 to-transparent p-2">
                                 <h3 class="text-white font-bold text-sm truncate text-shadow">${album.name}</h3>
                                 <p class="text-gray-200 text-xs">${album.photos.length} å¼µ</p>
                            </div>
                        </div>
                    </div>
                    `;
                });

                const minItemsForLoop = 6;
                let loopCount = 1;
                if (items.length < minItemsForLoop) loopCount = Math.ceil(minItemsForLoop / items.length);
                
                let finalHTML = contentHTML; 
                for(let i=0; i<loopCount; i++) finalHTML += contentHTML;

                track.innerHTML = finalHTML;
                wrapper.appendChild(track);
                return wrapper;
            };

            const mainFlex = document.createElement('div');
            mainFlex.className = 'flex flex-col h-full w-full overflow-hidden';

            const row1El = createMarqueeRow(row1Albums);
            const row2El = createMarqueeRow(row2Albums);

            if (row1El) mainFlex.appendChild(row1El);
            if (row2El) mainFlex.appendChild(row2El);

            container.appendChild(mainFlex);
        }

        // --- Gallery ä¸€èˆ¬ç€è¦½ ---
        function openGallery(albumId) {
            const album = albumsData.find(a => a.id === albumId);
            if (!album) return;
            currentAlbumPhotos = album.photos;
            currentPhotoIndex = 0;
            document.getElementById('gallery-title').innerText = album.name;
            const thumbStrip = document.getElementById('thumbnail-strip');
            thumbStrip.innerHTML = '';

            currentAlbumPhotos.forEach((photo, index) => {
                const thumb = document.createElement('div');
                thumb.className = `w-16 h-16 md:w-20 md:h-20 shrink-0 cursor-pointer rounded-lg overflow-hidden opacity-60 hover:opacity-100 transition duration-200 border-2 border-transparent`;
                thumb.id = `thumb-${index}`;
                thumb.onclick = () => {
                    currentPhotoIndex = index;
                    updateMainPhoto();
                };
                let imgContent = photo.type.startsWith('video') 
                    ? `<div class="w-full h-full bg-gray-800 flex items-center justify-center text-white"><i class="fa-solid fa-video"></i></div>` 
                    : `<img src="${photo.url}" class="w-full h-full object-cover">`;
                thumb.innerHTML = imgContent;
                thumbStrip.appendChild(thumb);
            });
            updateMainPhoto();
            document.getElementById('gallery-modal').classList.remove('hidden');
        }

        function updateMainPhoto() {
             const photo = currentAlbumPhotos[currentPhotoIndex];
             const mainView = document.getElementById('main-view');
             
             if (photo.type.startsWith('video')) {
                 // ä¿®æ”¹ï¼šæ”¹ç”¨ iframe è¼‰å…¥ Google Drive é è¦½é é¢ï¼Œè§£æ±º MOV/MP4 æ’­æ”¾èˆ‡æ¬Šé™å•é¡Œ
                 mainView.innerHTML = `<iframe src="https://drive.google.com/file/d/${photo.id}/preview" class="w-full h-full border-0 shadow-2xl" allow="autoplay; fullscreen"></iframe>`;
             } else {
                 mainView.innerHTML = `<img src="${photo.url}" onclick="document.getElementById('fullscreen-modal').classList.remove('hidden');document.getElementById('fullscreen-image').src=this.src;" class="max-w-full max-h-full object-contain shadow-2xl cursor-zoom-in">`;
             }
             
             // Update Thumbnails
             document.querySelectorAll('#thumbnail-strip > div').forEach(el => el.classList.remove('thumb-active'));
             const activeThumb = document.getElementById(`thumb-${currentPhotoIndex}`);
             if (activeThumb) { activeThumb.classList.add('thumb-active'); activeThumb.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' }); }
        }

        function nextPhoto() {
            currentPhotoIndex = (currentPhotoIndex + 1) % currentAlbumPhotos.length;
            updateMainPhoto();
        }
        function prevPhoto() {
            currentPhotoIndex = (currentPhotoIndex - 1 + currentAlbumPhotos.length) % currentAlbumPhotos.length;
            updateMainPhoto();
        }

        // --- å…¨è¢å¹•ç€è¦½ (Lightbox) ---
        function openFullscreen(src) {
            document.getElementById('fullscreen-image').src = src;
            document.getElementById('fullscreen-modal').classList.remove('hidden');
        }
        function closeFullscreen() {
            document.getElementById('fullscreen-modal').classList.add('hidden');
        }

        // --- ç°¡å ±èˆ‡è‡ªå‹•æ’­æ”¾æ¨¡å¼ (æ ¸å¿ƒä¿®æ”¹) ---

        function startPresentationMode(isAutoPlay = false) {
            const modal = document.getElementById('presentation-modal');
            const toolbar = document.getElementById('drawing-toolbar');
            const statusText = document.getElementById('presentation-status');
            const stage = document.getElementById('slide-stage');
            
            modal.classList.remove('hidden');

            if (document.documentElement.requestFullscreen) {
                document.documentElement.requestFullscreen().catch(e => console.log(e));
            }

            if (isAutoPlay) {
                toolbar.classList.add('toolbar-hidden');
                stage.style.cursor = 'none'; 
                statusText.innerText = "è‡ªå‹•æ’­æ”¾ä¸­ ğŸ“¸";
            } else {
                toolbar.classList.remove('toolbar-hidden');
                stage.style.cursor = 'crosshair'; 
                statusText.innerText = "ç°¡å ±æ¨¡å¼ âœï¸";
            }

            const images = stage.querySelectorAll('img, video, iframe'); // include iframe
            images.forEach(img => img.remove());
            
            createSlideImage(currentPhotoIndex, 'slide-center');
            
            resizePresentationCanvas();
            window.addEventListener('resize', resizePresentationCanvas);
            window.addEventListener('keydown', handlePresentationKeydown);

            if (isAutoPlay) {
                isPresentationPlaying = true;
                updatePlayButtonIcon();
                startPresentationTimer();
            } else {
                isPresentationPlaying = false;
                updatePlayButtonIcon();
                stopPresentationTimer();
            }
        }

        function closePresentationMode() {
            const modal = document.getElementById('presentation-modal');
            const stage = document.getElementById('slide-stage');
            modal.classList.add('hidden');
            stage.style.cursor = ''; 
            
            if (document.fullscreenElement) {
                document.exitFullscreen();
            }

            stopPresentationTimer();
            window.removeEventListener('resize', resizePresentationCanvas);
            window.removeEventListener('keydown', handlePresentationKeydown);
            
            updateMainPhoto();
        }

        function handlePresentationKeydown(e) {
            if (e.key === 'ArrowRight') nextSlide();
            if (e.key === 'ArrowLeft') prevSlide();
            if (e.key === 'Escape') closePresentationMode();
            if (e.key === ' ' || e.key === 'Spacebar') togglePresentationAutoPlay();
        }

        function nextSlide() {
            const oldIndex = currentPhotoIndex;
            currentPhotoIndex = (currentPhotoIndex + 1) % currentAlbumPhotos.length;
            performSlideTransition('next', oldIndex, currentPhotoIndex);
            
            if (isPresentationPlaying) {
                stopPresentationTimer();
                startPresentationTimer();
            }
            clearCanvas();
        }

        function prevSlide() {
            const oldIndex = currentPhotoIndex;
            currentPhotoIndex = (currentPhotoIndex - 1 + currentAlbumPhotos.length) % currentAlbumPhotos.length;
            performSlideTransition('prev', oldIndex, currentPhotoIndex);
            
            if (isPresentationPlaying) {
                stopPresentationTimer();
                startPresentationTimer();
            }
            clearCanvas();
        }

        function performSlideTransition(direction, oldIndex, newIndex) {
            const stage = document.getElementById('slide-stage');
            const currentImages = stage.querySelectorAll('.slide-image');
            const oldImg = currentImages.length > 0 ? currentImages[currentImages.length - 1] : null;

            const startClass = direction === 'next' ? 'slide-right' : 'slide-left';
            const endClass = 'slide-center';
            const oldEndClass = direction === 'next' ? 'slide-left' : 'slide-right';

            const newImg = createSlideImage(newIndex, startClass);
            
            void newImg.offsetWidth; 

            newImg.classList.remove(startClass);
            newImg.classList.add(endClass);

            if (oldImg) {
                oldImg.classList.remove('slide-center');
                oldImg.classList.add(oldEndClass);
                setTimeout(() => {
                    if (oldImg && oldImg.parentNode) oldImg.remove();
                }, 800); 
            }
        }

        function createSlideImage(index, initialClass) {
            const photo = currentAlbumPhotos[index];
            const stage = document.getElementById('slide-stage');
            
            let el;
            if (photo.type.startsWith('video')) { 
                // ä¿®æ”¹ï¼šç°¡å ±æ¨¡å¼ä¹Ÿæ”¹ç”¨ iframe
                el = document.createElement('iframe'); 
                el.src = `https://drive.google.com/file/d/${photo.id}/preview`; 
                el.allow = "autoplay; fullscreen";
                el.style.border = "0";
            } 
            else { 
                el = document.createElement('img'); 
                el.src = photo.url; 
            }
            el.className = `slide-image ${initialClass}`;
            stage.appendChild(el);
            return el;
        }

        function togglePresentationAutoPlay() {
            isPresentationPlaying = !isPresentationPlaying;
            if(!document.getElementById('drawing-toolbar').classList.contains('toolbar-hidden')) {
                updatePlayButtonIcon();
            }

            const statusText = document.getElementById('presentation-status');
            
            if (isPresentationPlaying) {
                statusText.innerText = "è‡ªå‹•æ’­æ”¾ä¸­ ğŸ“¸";
                startPresentationTimer();
            } else {
                statusText.innerText = "å·²æš«åœ â¸ï¸";
                stopPresentationTimer();
            }
        }

        function startPresentationTimer() {
            stopPresentationTimer();
            presentationTimer = setInterval(nextSlide, 3500); 
        }

        function stopPresentationTimer() {
            if (presentationTimer) {
                clearInterval(presentationTimer);
                presentationTimer = null;
            }
        }

        function updatePlayButtonIcon() {
            const btn = document.getElementById('btn-toggle-play');
            btn.innerHTML = isPresentationPlaying 
                ? '<i class="fa-solid fa-pause"></i>' 
                : '<i class="fa-solid fa-play"></i>';
        }

        // --- ç•«ç­†èˆ‡å·¥å…·åˆ— ---
        function initPresentationCanvas() {
            const canvas = document.getElementById('drawing-canvas');
            const startDraw = (e) => {
                const toolbar = document.getElementById('drawing-toolbar');
                if (toolbar.classList.contains('toolbar-hidden')) return;

                isDrawing = true;
                presentationCtx.beginPath();
                const { x, y } = getEventPos(e);
                presentationCtx.moveTo(x, y);
                presentationCtx.strokeStyle = currentPenColor;
                presentationCtx.lineWidth = 5;
                presentationCtx.lineCap = 'round';
                presentationCtx.lineJoin = 'round';
            };
            const draw = (e) => {
                if (!isDrawing) return;
                e.preventDefault();
                const { x, y } = getEventPos(e);
                presentationCtx.lineTo(x, y);
                presentationCtx.stroke();
            };
            const endDraw = () => { isDrawing = false; presentationCtx.closePath(); };

            canvas.addEventListener('mousedown', startDraw);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', endDraw);
            canvas.addEventListener('mouseout', endDraw);
            canvas.addEventListener('touchstart', startDraw, { passive: false });
            canvas.addEventListener('touchmove', draw, { passive: false });
            canvas.addEventListener('touchend', endDraw);
        }

        function getEventPos(e) {
            if (e.touches && e.touches.length > 0) return { x: e.touches[0].clientX, y: e.touches[0].clientY };
            return { x: e.clientX, y: e.clientY };
        }
        function resizePresentationCanvas() {
            const canvas = document.getElementById('drawing-canvas');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            presentationCtx = canvas.getContext('2d');
        }
        function setPenColor(color) { currentPenColor = color; }
        function clearCanvas() {
            const canvas = document.getElementById('drawing-canvas');
            if (presentationCtx) presentationCtx.clearRect(0, 0, canvas.width, canvas.height);
        }
        function toggleToolbar() {
            const tools = document.getElementById('drawing-tools');
            const icon = document.getElementById('toolbar-icon');
            if (isToolbarExpanded) {
                tools.style.width = '0px'; tools.style.padding = '0px'; tools.style.opacity = '0';
                icon.className = 'fa-solid fa-chevron-left';
            } else {
                tools.style.width = 'auto'; tools.style.padding = '0 0.5rem'; tools.style.opacity = '1';
                icon.className = 'fa-solid fa-chevron-right';
            }
            isToolbarExpanded = !isToolbarExpanded;
        }

        // --- æ‰“åŒ…ä¸‹è¼‰ ---
        async function downloadAlbumZip() {
            if (currentAlbumPhotos.length === 0) return;
            const albumName = document.getElementById('gallery-title').innerText;
            
            // é¸å–®ï¼šé¸æ“‡ä¸‹è¼‰æ¨¡å¼
            const { value: downloadType } = await Swal.fire({
                title: 'é¸æ“‡ä¸‹è¼‰æ¨¡å¼',
                text: `å³å°‡ä¸‹è¼‰ã€Œ${albumName}ã€çš„ ${currentAlbumPhotos.length} å¼µç…§ç‰‡`,
                icon: 'question',
                input: 'radio',
                inputOptions: {
                    'fast': 'ğŸš€ å¿«é€Ÿä¸‹è¼‰ (å£“ç¸®åœ–ï¼šé€Ÿåº¦å¿«)',
                    'original': 'ğŸ’¾ åŸå§‹æª”æ¡ˆä¸‹è¼‰ (é«˜ç•«è³ªï¼šé€Ÿåº¦æ…¢ã€éœ€ç­‰å¾…)'
                },
                inputValue: 'fast', // é è¨­é¸é …
                showCancelButton: true,
                confirmButtonText: 'é–‹å§‹ä¸‹è¼‰',
                cancelButtonText: 'å–æ¶ˆ',
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33'
            });

            if (!downloadType) return; // ä½¿ç”¨è€…å–æ¶ˆ

            const zip = new JSZip();
            const folder = zip.folder(albumName);
            
            Swal.fire({
                title: 'æ‰“åŒ…ä¸­...',
                text: downloadType === 'original' ? 'æ­£åœ¨å¾é›²ç«¯ç¡¬ç¢ŸæŠ“å–åŸå§‹æª”æ¡ˆï¼Œå½±ç‰‡éå¤§æ™‚å°‡æ”¹ç”¨é«˜ç•«è³ªä¸²æµæª”...' : 'æ­£åœ¨å¿«é€Ÿæ‰“åŒ…ç…§ç‰‡...',
                didOpen: () => Swal.showLoading(),
                allowOutsideClick: false
            });
            
            const promises = currentAlbumPhotos.map(async (photo, i) => {
                try {
                    let fetchPromise;
                    let ext = photo.type.includes('video') ? 'mp4' : 'jpg';

                    if (downloadType === 'original') {
                        if (photo.type.includes('video')) {
                            // å½±ç‰‡ç‰¹æ®Šè™•ç†é‚è¼¯ï¼šé˜²æ­¢ä¸‹è¼‰åˆ°ç—…æ¯’æƒæ HTML é é¢
                            try {
                                const response = await fetch(photo.downloadUrl, { mode: 'cors' });
                                const contentType = response.headers.get('content-type');
                                
                                // æª¢æŸ¥æ˜¯å¦è¢« Google Drive æ“‹ä¸‹ä¾† (å›å‚³äº† HTML è€Œä¸æ˜¯å½±ç‰‡)
                                if (contentType && contentType.includes('text/html')) {
                                    console.warn(`åŸå§‹å½±ç‰‡ä¸‹è¼‰å—é˜» (ID: ${photo.id})ï¼Œå˜—è©¦é™ç´šä¸‹è¼‰ä¸²æµç‰ˆæœ¬...`);
                                    // å˜—è©¦ä¸‹è¼‰ 720p ä¸²æµç‰ˆæœ¬ (m22 = 720p, m18 = 360p)
                                    // é€™é€šå¸¸å¯ä»¥ç›´æ¥ä¸‹è¼‰è€Œä¸æœƒè¢«æ“‹
                                    const fallbackUrl = `https://lh3.googleusercontent.com/d/${photo.id}=m22`;
                                    fetchPromise = fetch(fallbackUrl).then(res => {
                                        if(!res.ok) throw new Error("Fallback failed");
                                        return res.blob();
                                    });
                                } else {
                                    // æ­£å¸¸ä¸‹è¼‰
                                    fetchPromise = response.blob();
                                }
                            } catch (e) {
                                // å¦‚æœä¸Šé¢éƒ½å¤±æ•—ï¼Œå˜—è©¦æœ€å¾Œä¸€æ‹›ï¼šä¸‹è¼‰é è¦½åœ–ç•¶ä½œæ›¿ä»£ï¼Œé¿å… ZIP ææ¯€
                                console.error("å½±ç‰‡ä¸‹è¼‰å¤±æ•—ï¼Œæ”¹å­˜é è¦½åœ–", e);
                                ext = 'jpg';
                                fetchPromise = fetch(photo.url).then(res => res.blob());
                            }
                        } else {
                            // åœ–ç‰‡ç›´æ¥ä¸‹è¼‰
                            fetchPromise = fetch(photo.downloadUrl, { mode: 'cors' })
                                .catch(() => fetch(photo.url.replace(/=s\d+$/, '=d'))); // å¤±æ•—å˜—è©¦ =d
                        }
                    } else {
                        // å¿«é€Ÿä¸‹è¼‰æ¨¡å¼
                        if (photo.type.includes('video')) {
                            // å¿«é€Ÿæ¨¡å¼ä¸‹ï¼Œå½±ç‰‡åªä¸‹è¼‰å°é¢åœ– (JPG)
                            ext = 'jpg'; 
                            fetchPromise = fetch(photo.url).then(res => res.blob());
                        } else {
                            fetchPromise = fetch(photo.url).then(res => res.blob());
                        }
                    }

                    const blob = await fetchPromise;
                    if (blob) {
                        folder.file(`${albumName}_${i+1}.${ext}`, blob);
                    }
                } catch (e) { 
                    console.error(`ä¸‹è¼‰å–®å¼µå¤±æ•—: ${photo.name}`, e); 
                }
            });

            await Promise.all(promises);
            const content = await zip.generateAsync({ type: "blob" });
            saveAs(content, `${albumName}.zip`);
            Swal.fire('ä¸‹è¼‰å®Œæˆ', downloadType === 'original' ? 'åŸå§‹æª”æ¡ˆæ‰“åŒ…å®Œæˆï¼(å½±ç‰‡å¦‚ç„¡æ³•ä¸‹è¼‰å·²è‡ªå‹•è½‰ç‚ºä¸²æµç‰ˆ)' : 'å¿«é€Ÿæ‰“åŒ…å®Œæˆï¼(å½±ç‰‡åƒ…å«å°é¢)', 'success');
        }

        // --- è¨­å®šèˆ‡åˆ†äº«åŠŸèƒ½ (ä¿®æ­£èˆ‡æ–°å¢) ---
        
        function updateUploadOptions(albums) {
            const datalist = document.getElementById('album-options');
            datalist.innerHTML = '';
            albums.forEach(a => datalist.appendChild(new Option(a.name, a.name)));
        }

        async function processAndUpload() { 
            /* æ­¤åŠŸèƒ½éœ€è¦å¾Œç«¯é…åˆï¼Œé€™è£¡åƒ…ä¿ç•™çµæ§‹ */
            const fileInput = document.getElementById('file-input');
            const albumName = document.getElementById('upload-album-name').value;
            if (!fileInput.files.length || !albumName) {
                Swal.fire('éŒ¯èª¤', 'è«‹é¸æ“‡åœ–ç‰‡ä¸¦è¼¸å…¥ç›¸ç°¿åç¨±', 'error');
                return;
            }
            Swal.fire('ä¸Šå‚³ä¸­', 'åŠŸèƒ½æ¼”ç¤ºï¼šè«‹ç¢ºèª GAS å¾Œç«¯å·²éƒ¨ç½²', 'info');
        }

        function openSettings() { document.getElementById('settings-modal').classList.remove('hidden'); }
        function closeSettings() { document.getElementById('settings-modal').classList.add('hidden'); }
        function toggleVisibility() { const el = document.getElementById('gas-url-input'); el.type = el.type==='password'?'text':'password'; }
        
        // å„²å­˜è¨­å®š
        function saveSettings() {
            const url = document.getElementById('gas-url-input').value.trim();
            const title = document.getElementById('app-title-input').value.trim();
            
            if (!url) {
                Swal.fire('éŒ¯èª¤', 'è«‹è¼¸å…¥ GAS ç¶²å€', 'error');
                return;
            }

            localStorage.setItem('gas_app_url', url);
            localStorage.setItem('app_title', title || "å¿«æ¨‚å°å­¸å ‚ç›¸ç°¿");
            
            gasUrl = url;
            appTitle = title;
            updateAppTitleUI(appTitle);
            
            const scriptId = getScriptId(gasUrl);
            initDB(scriptId);

            closeSettings();
            fetchAlbums(); 
            Swal.fire('å·²å„²å­˜', 'è¨­å®šå·²æ›´æ–°ä¸¦é‡æ–°é€£ç·š', 'success');
        }

        // æ¸…é™¤è¨­å®š (Reset)
        async function resetSettings() {
            Swal.fire({
                title: 'ç¢ºå®šè¦æ¸…é™¤è¨­å®šå—ï¼Ÿ',
                text: "é€™å°‡æœƒåˆªé™¤å„²å­˜çš„ GAS ç¶²å€èˆ‡æ¨™é¡Œï¼Œä¸¦é‡æ•´ç¶²é å›åˆ°åˆå§‹ç‹€æ…‹ã€‚",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'æ˜¯çš„ï¼Œæ¸…é™¤ï¼',
                cancelButtonText: 'å–æ¶ˆ'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    localStorage.removeItem('gas_app_url');
                    localStorage.removeItem('app_title');
                    // æ¸…é™¤ IDB
                    await idb.clear();
                    // æ¸…é™¤ç¶²å€åƒæ•¸ä¸¦é‡æ•´
                    window.location.href = window.location.pathname;
                }
            });
        }

        // ç”¢ç”Ÿåˆ†äº«é€£çµ
        async function generateShareLink() {
            const url = document.getElementById('gas-url-input').value.trim();
            const title = document.getElementById('app-title-input').value.trim();
            
            if (!url) {
                Swal.fire('ç„¡æ³•ç”¢ç”Ÿ', 'è«‹å…ˆè¼¸å…¥ä¸¦å„²å­˜ GAS ç¶²å€', 'warning');
                return;
            }

            try {
                // Base64 ç·¨ç¢¼
                const config = btoa(url); 
                const baseUrl = window.location.origin + window.location.pathname;
                const shareUrl = `${baseUrl}?title=${encodeURIComponent(title)}&config=${config}`;

                // è¨­å®šé€£çµ
                const output = document.getElementById('share-url-output');
                output.value = shareUrl;
                document.getElementById('open-share-link').href = shareUrl;
                
                // ç”¢ç”Ÿ QR Code (ä½¿ç”¨ QR Server API)
                document.getElementById('qr-code-img').src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(shareUrl)}`;
                
                // é¡¯ç¤ºçµæœå€åŸŸ
                document.getElementById('share-result').classList.remove('hidden');
                document.getElementById('embed-result').classList.add('hidden'); 
            } catch (e) {
                console.error(e);
                Swal.fire('éŒ¯èª¤', 'ç”¢ç”Ÿé€£çµæ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
            }
        }
        
        // ç”¢ç”ŸåµŒå…¥èªæ³•
        function generateEmbedCode() {
            const url = document.getElementById('gas-url-input').value.trim();
            const title = document.getElementById('app-title-input').value.trim();
            if (!url) { Swal.fire('æç¤º', 'è«‹å…ˆå„²å­˜ GAS ç¶²å€', 'warning'); return; }

            const limit = document.getElementById('embed-limit').value || 16;
            const config = btoa(url);
            const baseUrl = window.location.origin + window.location.pathname;
            
            // çµ„åˆ Widget URL
            const widgetUrl = `${baseUrl}?title=${encodeURIComponent(title)}&config=${config}&mode=widget&limit=${limit}`;
            
            // ç”¢ç”Ÿ Iframe Tag (èª¿æ•´é«˜åº¦ä»¥å®¹ç´å…©æ’)
            const iframeCode = `<iframe src="${widgetUrl}" width="100%" height="540" frameborder="0" scrolling="no" style="border:none; overflow:hidden; background:transparent;"></iframe>`;

            document.getElementById('embed-code-output').value = iframeCode;
            
            document.getElementById('embed-result').classList.remove('hidden');
            document.getElementById('share-result').classList.add('hidden'); // éš±è—åˆ†äº«å€
        }
        
        function copyEmbedCode() {
            const copyText = document.getElementById("embed-code-output");
            copyText.select();
            navigator.clipboard.writeText(copyText.value).then(() => {
                 Swal.fire({ icon: 'success', title: 'å·²è¤‡è£½èªæ³•', toast: true, position: 'top-end', showConfirmButton: false, timer: 1500 });
            });
        }

        // è¤‡è£½åˆ†äº«é€£çµ
        function copyShareUrl() {
            const copyText = document.getElementById("share-url-output");
            copyText.select();
            copyText.setSelectionRange(0, 99999); // For mobile
            navigator.clipboard.writeText(copyText.value).then(() => {
                 Swal.fire({
                    icon: 'success',
                    title: 'å·²è¤‡è£½é€£çµ',
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 1500
                });
            });
        }

        function openHelp() { document.getElementById('help-modal').classList.remove('hidden'); }
        function closeHelp() { document.getElementById('help-modal').classList.add('hidden'); }
        // ä¿®æ­£å¾Œçš„è¤‡è£½ç¨‹å¼ç¢¼å‡½å¼
        function copyCode() { 
            navigator.clipboard.writeText(gasCodeString)
                .then(() => {
                    Swal.fire({
                        icon: 'success',
                        title: 'è¤‡è£½æˆåŠŸ',
                        text: 'ç¨‹å¼ç¢¼å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼Œè«‹è²¼ä¸Šåˆ° Apps Script ç·¨è¼¯å™¨ä¸­ã€‚',
                        timer: 2000,
                        showConfirmButton: false
                    });
                })
                .catch(err => {
                    console.error('è¤‡è£½å¤±æ•—:', err);
                    Swal.fire('éŒ¯èª¤', 'ç„¡æ³•è¤‡è£½ç¨‹å¼ç¢¼ï¼Œè«‹æ‰‹å‹•é¸å–è¤‡è£½ã€‚', 'error');
                });
        }
        function openUploadModal() { document.getElementById('upload-modal').classList.remove('hidden'); }
        function closeUploadModal() { document.getElementById('upload-modal').classList.add('hidden'); }
        function closeGallery() { document.getElementById('gallery-modal').classList.add('hidden'); document.getElementById('main-view').innerHTML = ''; }
    </script>
</body>
</html>
